// é‡åŒ–äº¤æ˜“é¢æ¿ TypeScript å®ç° - è‡ªé€‚åº”æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯
import { useFactorsData, type Dimension } from './hooks/useFactorsData';
import { useFactorIndex, type FactorContribSeries, type FactorIndexPoint } from './hooks/useFactorIndex';
import { pushToQueue } from "./sim/store";
import { initMineUI } from "./mine";

// ç”¨æˆ·å‚æ•°æ¥å£
interface UserParams {
  profitTarget: number;
  maxDrawdown: number;
  riskExposure: number;
  capitalSize: number;
  monitoringFreq: string;
}

// APIæ•°æ®æ¥å£
interface ApiQuote {
  symbol: string;
  close: number;
  changePercent: string;
  isPositive: boolean;
}

interface ApiSignal {
  symbol: string;
  strategy: string;
  side: string;
  entry: number;
  target: number;
  stop: number;
  confidence: number;
  tf: string;
  time: string;
}

// æ£€æµ‹è®¾å¤‡ç±»å‹
const isMobile = () => {
  return window.innerWidth <= 768 ||
         /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
         (window.navigator && 'maxTouchPoints' in window.navigator && window.navigator.maxTouchPoints > 0);
};

// å›ºå®šåç«¯çœŸå®æ•°æ®åœ°å€ï¼ˆæœ¬æœºï¼‰
const BASE_API = 'http://127.0.0.1:8889';

// ç§»åŠ¨ç«¯ä¼˜åŒ–ç•Œé¢ç±»
class MobileTradingDashboard {
  private currentTab: 'home' | 'vip' | 'backtest' | 'profile' | 'info' | 'å› å­' = 'home';
  private currentTimeframe = '4h';
  private activeStrategies: Set<string> = new Set(['vegas_tunnel', 'chan_simplified', 'macd']);
  private updateTimer: ReturnType<typeof setTimeout> | undefined;
  // Info page state
  private infoInited: boolean = false;
  private infoSelectedKey: 'macro' | 'policy' | 'capital' | 'geopolitics' | 'onchain' | 'sentiment' = 'macro';
  private infoChart: any = null;
  private echartsMod: any = null;
  private onInfoResize: (() => void) | null = null;
  private infoData: Dimension[] = [];
  private infoAsOf: string = '';
  private infoIndex: FactorIndexPoint[] = [];
  private infoContrib: FactorContribSeries[] = [];
  private infoCurrentIdx: number = -1;
  private infoSelectedFactor: string | null = null;
  private infoEventBus: { emit: (event: string, data?: any) => void; on: (event: string, handler: (data?: any) => void) => void } = { emit: () => {}, on: () => {} };
  
  // å®è§‚æ•°æ®ç›¸å…³
  private macroEventBus: { emit: (event: string, data?: any) => void; on: (event: string, handler: (data?: any) => void) => void } = { emit: () => {}, on: () => {} };
  private macroCurrentRange: string = '30D';
  private macroETFFNGChart: any = null;
  private macroFundingChart: any = null;
  private macroETFFNGData: any[] = [];
  private macroFundingData: any = null;

  // å­˜å‚¨ç”¨æˆ·å‚æ•°çš„çŠ¶æ€
  private userParams: UserParams = {
    profitTarget: 5,
    maxDrawdown: 15,
    riskExposure: 5,
    capitalSize: 10000,
    monitoringFreq: 'daily'
  };

  // æ ‡è®°ç”¨æˆ·æ˜¯å¦å·²ç»ä¿å­˜è¿‡é…ç½®
  private hasConfiguredFlag = false;

  private basePrices: Record<string, number> = {
    'BTC': 65000, 'ETH': 3200, 'BNB': 590, 'SOL': 140, 'XRP': 0.52,
    'ADA': 0.45, 'DOGE': 0.12, 'TRX': 0.08, 'AVAX': 28, 'DOT': 6.5,
    'SHIB': 0.000024, 'LINK': 12.5, 'TON': 5.8, 'LTC': 85, 'MATIC': 0.85
  };

  constructor() {
    this.loadUserParamsFromStorage();
    this.createMobileUI();
    this.setupMobileEventListeners();
    this.startUpdates();
    
    // é¢„åŠ è½½EChartsï¼Œæå‰å¼€å§‹åŠ è½½
    this.preloadECharts();
    
    // é¢„åŠ è½½å› å­æ•°æ®ï¼Œæå‰å¼€å§‹è®¡ç®—
    this.preloadFactorsData();
    
    // åˆå§‹åŒ–å®è§‚æ•°æ®äº‹ä»¶æ€»çº¿
    this.initMacroEventBus();
  }
  
  private preloadECharts() {
    // æå‰å¼€å§‹åŠ è½½EChartsï¼Œä¸ç­‰å¾…ç”¨æˆ·ç‚¹å‡»å› å­é¡µ
    import('echarts').then((mod) => {
      const echartsAny: any = (mod as any)?.default || (mod as any);
      this.echartsMod = echartsAny;
      console.log('[info] ECharts preloaded successfully');
    }).catch((error) => {
      console.error('[info] ECharts preload error:', error);
    });
  }
  
  private preloadFactorsData() {
    // ç«‹å³å¼€å§‹åŠ è½½å› å­æ•°æ®ï¼Œä¸ç­‰å¾…ç”¨æˆ·ç‚¹å‡»å› å­é¡µ
    this.refreshInfoData().catch((error) => {
      console.warn('[info] Factors data preload failed:', error);
    });
  }
  
  private initMacroEventBus() {
    // å®è§‚æ•°æ®äº‹ä»¶æ€»çº¿
    this.macroEventBus = {
      emit: (event: string, data?: any) => {
        document.dispatchEvent(new CustomEvent(`macro:${event}`, { detail: data }));
      },
      on: (event: string, handler: (data?: any) => void) => {
        document.addEventListener(`macro:${event}`, (e: any) => handler(e.detail));
      }
    };
  }
  
  private initCharts() {
    console.log('[info] Initializing charts...');
    const radarEl = document.getElementById('info-radar') as HTMLElement | null;
    if (radarEl && this.echartsMod && !this.infoChart) {
      this.infoChart = this.echartsMod.init(radarEl);
    }
    
    // å¦‚æœæ•°æ®å·²ç»å‡†å¤‡å¥½ï¼Œç«‹å³æ¸²æŸ“
    if (this.infoData.length > 0 || this.infoIndex.length > 0) {
      this.renderInfoRadar();
      this.renderInfoContribution();
      this.renderInfoRadarSnapshot();
    }
  }

  private createMobileUI() {
    document.body.innerHTML = `
      <div class="mobile-app">
        <header class="mobile-header">
          <div class="header-right">
            <div class="api-status" id="api-status">
              <div class="status-dot offline"></div>
              <span class="status-text">è¿æ¥ä¸­...</span>
            </div>
            <div class="learning-stats" id="learning-stats" data-clickable="1">
              <div class="stat-item">
                <div class="stat-label">èƒœç‡</div>
                <div class="stat-value" id="win-rate">--/--</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">æœ€å¤§å›æ’¤</div>
                <div class="stat-value" id="max-drawdown-stat">--/--</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">ç´¯è®¡æ”¶ç›Š</div>
                <div class="stat-value" id="profit-ratio">--/--</div>
              </div>
            </div>
            <button class="manage-signals-btn" id="manage-signals-btn">ç­–ç•¥ç®¡ç†</button>
          </div>
        </header>

        <div class="timeframe-tabs">
          <button class="tf-tab active" data-tf="4h">4H</button>
          <button class="tf-tab" data-tf="1d">1D</button>
          <button class="tf-tab" data-tf="1w">1W</button>
        </div>

        <main class="mobile-content">
          <div id="market-view" class="tab-content active">

            <!-- ç¬¬ä¸€å—ï¼šå®æ—¶è¡Œæƒ… -->
            <div class="market-section">
              <h3 class="section-title">ğŸ’¹ å®æ—¶è¡Œæƒ…</h3>
              <div class="quotes-enhanced" id="quotes-enhanced"></div>
            </div>

            <!-- ç¬¬äºŒå—ï¼šäº¤æ˜“ä¿¡å·åŒº -->
            <div class="signals-section">
              <h3 class="section-title">ğŸš€ äº¤æ˜“ä¿¡å·</h3>
              <div class="signals-disclaimer">
                ç­–ç•¥ä»…ä¾›å­¦ä¹ ï¼Œè¯·å‹¿ä½œä¸ºæŠ•èµ„ä¾æ®
              </div>
              <div class="signals-cards" id="signals-cards"></div>
            </div>

            <!-- ç¬¬å››å—ï¼šä¸ªæ€§åŒ–æ¨è -->
            <div class="recommendation-section">
              <h3 class="section-title">ğŸ¯ ä¸ªæ€§åŒ–æ¨è</h3>
              <div class="recommendation-config-hint" id="recommendation-config-hint">
                <div class="config-hint-content">
                  <div class="config-hint-icon">âš™ï¸</div>
                  <div class="config-hint-text">
                    <div class="config-hint-title">è®¾ç½®æ‚¨çš„äº¤æ˜“å‚æ•°</div>
                    <div class="config-hint-desc">æ”¶ç›Šç›®æ ‡ã€é£é™©åå¥½ã€æœ¬é‡‘è§„æ¨¡ç­‰</div>
                  </div>
                  <button class="config-hint-btn" onclick="window.goToSettings()">
                    <span>é…ç½®å‚æ•°</span>
                    <span>â†’</span>
                  </button>
                </div>
              </div>
              <div class="recommendation-cards" id="recommendation-cards"></div>
            </div>

            <!-- ç¬¬äº”å—ï¼šå¤ç›˜ + æ’è¡Œæ¦œ -->
            <div class="performance-section">
              <h3 class="section-title">ğŸ“ˆ å¤ç›˜ & æ’è¡Œæ¦œ</h3>
              <div class="performance-grid">
                <div class="review-panel" id="review-panel">
                  <h4>æ˜¨æ—¥ä¿¡å·å¤ç›˜</h4>
                  <div class="review-content" id="review-content"></div>
                </div>
                <div class="ranking-panel" id="ranking-panel">
                  <h4>ç­–ç•¥èƒœç‡æ’è¡Œ</h4>
                  <div class="ranking-content" id="ranking-content"></div>
                </div>
              </div>
            </div>
          </div>

          <div id="vip-view" class="tab-content">
            <div class="settings-panel">
              <h3>ä¼šå‘˜æ–¹æ¡ˆ</h3>
              <div class="recommendation-cards">
                <div class="recommendation-card"><div class="recommendation-title">Basic</div><div class="recommendation-content">æ ¸å¿ƒæŒ‡æ ‡å±•ç¤ºï¼ŒåŸºç¡€ç­–ç•¥ä¿¡å·</div><div class="recommendation-actions"><button class="signal-btn signal-btn-secondary">å¼€å§‹è¯•ç”¨</button></div></div>
                <div class="recommendation-card"><div class="recommendation-title">Pro</div><div class="recommendation-content">å…¨éƒ¨ç­–ç•¥ä¸å¿«é€Ÿå›æµ‹ï¼Œå†å²å¤ç›˜ä¸å¯¹æ¯”</div><div class="recommendation-actions"><button class="signal-btn signal-btn-primary">ç«‹å³è®¢é˜…</button></div></div>
                <div class="recommendation-card"><div class="recommendation-title">Hyper</div><div class="recommendation-content">é«˜çº§ç­›é€‰ã€ç­–ç•¥ç»„åˆä¸ä¸ªæ€§åŒ–å»ºè®®</div><div class="recommendation-actions"><button class="signal-btn signal-btn-primary">ç«‹å³è®¢é˜…</button></div></div>
              </div>
            </div>
          </div>

          <div id="settings-view" class="tab-content">
            <div class="settings-panel">
              <h3>å›æµ‹é¡µè¯´æ˜</h3>
              <div class="recommendation-config-hint" style="margin-bottom: 20px;">
                <div class="config-hint-content">
                  <div class="config-hint-icon">â„¹ï¸</div>
                  <div class="config-hint-text">
                    <div class="config-hint-title">æ­¤å¤„ä»…ç”¨äºå†å²è¡¨ç°å¤ç›˜ä¸ç­–ç•¥å¯¹æ¯”ï¼Œä¸å½±å“å®æ—¶ä¿¡å·</div>
                    <div class="config-hint-desc">ç­–ç•¥å¼€å…³è¯·åœ¨"å¸‚åœº"é¡µå³ä¸Šè§’çš„"ç®¡ç†å®æ—¶ä¿¡å·"ä¸­è®¾ç½®</div>
                  </div>
                </div>
              </div>

              <!-- ä¸ªæ€§åŒ–å‚æ•°è®¾ç½®å·²ä»å›æµ‹é¡µç§»é™¤ï¼ˆä¾æ®â€œæˆ‘çš„é¡µä¸ºé…ç½®ä¸­å¿ƒâ€çš„ä¿¡æ¯æ¶æ„ï¼‰ -->

              <h3>å›æµ‹å·¥å…·</h3>
              <div class="backtest-panel">
                <label>å›æµ‹å‘¨æœŸ</label>
                <input type="range" id="lookahead-slider" min="4" max="60" value="12">
                <span id="lookahead-value">12</span> æ ¹Kçº¿
                <button class="btn-primary" onclick="window.runMobileBacktest()">è¿è¡Œå›æµ‹</button>
              </div>
            </div>
          </div>

          <div id="info-view" class="tab-content">
            <div class="info-container">
              <div class="info-toolbar" id="info-toolbar">
                <div class="toolbar-group">
                  <label>èµ„äº§</label>
                  <select id="info-asset">
                    <option>BTC</option>
                    <option>ETH</option>
                  </select>
                </div>
                <div class="toolbar-group">
                  <label>ç²’åº¦</label>
                  <select id="info-granularity">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                  </select>
                </div>
                <div class="toolbar-group">
                  <label>æ—¥æœŸ</label>
                  <input id="info-date" type="date" />
                </div>
                <button class="toolbar-btn" id="info-export">å¯¼å‡º PNG</button>
              </div>
              <div class="info-tip" id="info-tip">æ•°æ®æºï¼šå…¬å¼€APIï¼ˆ10åˆ†é’Ÿç¼“å­˜ï¼‰</div>
              <div class="info-summary" id="info-summary"></div>
              <div class="info-grid">
                <div class="info-main">
                  <div class="info-chart-controls">
                    <button class="toolbar-btn" id="info-help">â“˜</button>
                  </div>
                  <div class="info-radar" id="info-radar">
                    <div class="info-loading" id="info-loading" style="display: flex !important;">
                      <div class="loading-spinner"></div>
                      <div class="loading-text">è®¡ç®—ä¸­...</div>
                    </div>
                  </div>
                </div>
                <div class="info-radar-snapshot" id="info-radar-snapshot"></div>
                
                <!-- ETF æµå…¥ Ã— Fear & Greed -->
                <div class="macro-factors-card" id="card-etf-fng">
                  <div class="macro-card-header">
                    <div class="macro-card-title">
                      <h3>ETF æµå…¥ Ã— Fear & Greed</h3>
                      <p>æœºæ„èµ„é‡‘ä¸å¸‚åœºæƒ…ç»ªï¼ŒåŒæ­¥è§‚å¯Ÿ</p>
                    </div>
                    <div class="macro-card-controls">
                      <div class="time-range-selector">
                        <button class="range-btn" data-range="7D">7D</button>
                        <button class="range-btn active" data-range="30D">30D</button>
                        <button class="range-btn" data-range="90D">90D</button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="chart-etf-fng" id="chart-etf-fng">
                    <div class="chart-loading">
                      <div class="loading-spinner"></div>
                      <div class="loading-text">åŠ è½½ETFæ•°æ®...</div>
                    </div>
                  </div>
                </div>
                
                <!-- èµ„é‡‘è´¹ç‡çƒ­åŠ›å›¾ -->
                <div class="macro-factors-card" id="card-funding-heat">
                  <div class="macro-card-header">
                    <div class="macro-card-title">
                      <h3>èµ„é‡‘è´¹ç‡çƒ­åŠ›å›¾</h3>
                      <p>å¤šäº¤æ˜“æ‰€å¤šå¸ç§çš„æ æ†ä¾§å‹åŠ›</p>
                    </div>
                    <div class="macro-card-controls">
                      <div class="time-range-selector">
                        <button class="range-btn" data-range="7D">7D</button>
                        <button class="range-btn active" data-range="30D">30D</button>
                        <button class="range-btn" data-range="90D">90D</button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="chart-funding-heat" id="chart-funding-heat">
                    <div class="chart-loading">
                      <div class="loading-spinner"></div>
                      <div class="loading-text">åŠ è½½èµ„é‡‘è´¹ç‡æ•°æ®...</div>
                    </div>
                  </div>
                </div>
                
                <div class="info-detail" id="info-detail">
                  <div class="info-panel">
                    <div class="panel-title">å­å› å­è¯¦æƒ…</div>
                    <div class="panel-body" id="info-detail-body">é€‰æ‹©å·¦ä¾§ç»´åº¦æŸ¥çœ‹è¯¦æƒ…</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="profile-view" class="tab-content">
            <div class="settings-panel">
              <h3>è´¦æˆ·è¡¨ç°</h3>
              <div class="backtest-results" id="acct-performance">
                <div class="backtest-title">ç›ˆäºä¸ç´¯è®¡æ”¶ç›Š</div>
                <div class="backtest-grid">
                  <div class="backtest-item"><div class="backtest-label">è¿‘30å¤©èƒœç‡</div><div class="backtest-value" id="pf-win">--</div></div>
                  <div class="backtest-item"><div class="backtest-label">æœ€å¤§å›æ’¤</div><div class="backtest-value" id="pf-dd">--</div></div>
                  <div class="backtest-item"><div class="backtest-label">ç´¯è®¡æ”¶ç›Š</div><div class="backtest-value" id="pf-ret">--</div></div>
                </div>
              </div>
              <h3>å‚æ•°å®šåˆ¶</h3>
              <div class="personal-settings">
                <div class="setting-item"><label>æ”¶ç›Šç›®æ ‡ï¼ˆæœˆåŒ–ï¼‰</label><div class="slider-container"><input type="range" id="p-profit" min="0" max="30" value="5" step="1"><span id="p-profit-val">5%</span></div></div>
                <div class="setting-item"><label>æœ€å¤§å›æ’¤</label><div class="slider-container"><input type="range" id="p-dd" min="5" max="50" value="15" step="1"><span id="p-dd-val">15%</span></div></div>
                <div class="setting-item"><label>é£é™©æš´éœ²</label><div class="slider-container"><input type="range" id="p-risk" min="1" max="20" value="5" step="0.5"><span id="p-risk-val">5%</span></div></div>
                <div class="setting-item"><label>æœ¬é‡‘è§„æ¨¡ï¼ˆUSDTï¼‰</label><input type="number" id="p-capital" value="10000" min="1000" max="1000000" step="1000" placeholder="è¾“å…¥USDTæ•°é¢"></div>
                <div class="setting-item"><label>ç›¯ç›˜é¢‘ç‡</label><select id="p-monitor"><option value="realtime">éšæ—¶ç›‘æ§</option><option value="daily" selected>æ¯æ—¥1æ¬¡</option><option value="weekly">æ¯å‘¨1æ¬¡</option></select></div>
              </div>
              <div class="personal-settings-actions"><button class="btn-primary">ä¿å­˜å‚æ•°</button></div>
              <h3>å½“å‰å¯ç”¨çš„ç­–ç•¥ï¼ˆStrategyï¼‰</h3>
              <div class="recommendation-cards"><div class="recommendation-card"><div class="recommendation-title">å½“å‰å¯ç”¨</div><div class="recommendation-actions"><button class="signal-btn signal-btn-primary" id="open-strategy-manager">ç®¡ç†ç­–ç•¥</button></div></div></div>

              <!-- æˆ‘çš„ Â· æ¨¡æ‹Ÿäº¤æ˜“ -->
              <div class="signals-section">
                <h2>å¾…å¯ç”¨çš„ä¿¡å·ï¼ˆSignalï¼‰</h2>
                <div style="display:flex; gap:12px; margin:8px 0 12px;">
                  <button class="timeframe-btn" id="btn-enable-all">ä¸€é”®å¯ç”¨å…¨éƒ¨</button>
                </div>
                <div id="mine-queued"></div>
              </div>

              <div class="signals-section">
                <h2>è¿è¡Œä¸­ï¼ˆæ¨¡æ‹ŸæŒä»“ï¼‰ï¼ˆPositionï¼‰</h2>
                <div id="mine-open"></div>
              </div>

              <div class="signals-section">
                <h2>ğŸ“œ å†å²ï¼ˆå·²å…³é—­ï¼‰</h2>
                <div id="mine-history"></div>
              </div>
            </div>
          </div>
        </main>

        <nav class="bottom-nav">
          <button class="nav-btn active" data-tab="home">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">é¦–é¡µ</span>
          </button>
          <button class="nav-btn" data-tab="vip">
            <span class="nav-icon">ğŸ’</span>
            <span class="nav-label">ä¼šå‘˜</span>
          </button>
          <button class="nav-btn" data-tab="info">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-label">å› å­</span>
          </button>
          <button class="nav-btn tab-item" data-tab="profile" id="nav-mine">
            <span class="nav-label label">æˆ‘çš„</span>
            <span class="mine-badge" id="mine-badge">0</span>
          </button>
        </nav>

        <button class="fab-refresh" onclick="window.refreshMobileData()">
          <span class="refresh-icon">ğŸ”„</span>
        </button>
      </div>
    `;

    this.addMobileStyles();
  }

  private addMobileStyles() {
    const style = document.createElement('style');
    style.textContent = `
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'PingFang SC', sans-serif;
        background: #0B0F14;
        color: #E6EDF6;
        overflow-x: hidden;
        font-size: 16px;
        line-height: 1.375;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* iOS è®¾è®¡ç³»ç»Ÿ CSS å˜é‡ */
      :root {
        /* èƒŒæ™¯è‰² */
        --bg-primary: #0B0F14;
        --bg-surface: #0F1621;
        --bg-surface-2: #121C2A;
        --border-base: #1F2A3A;

        /* æ–‡æœ¬è‰² */
        --text-primary: #E6EDF6;
        --text-secondary: #A7B1C2;
        --text-muted: #6E7A8A;

        /* å“ç‰Œè‰² */
        --brand-primary: #00D5FF;
        --brand-primary-600: #00B8E6;
        --brand-bg: rgba(0, 213, 255, 0.16);

        /* å¤šç©ºè¯­ä¹‰è‰² */
        --bull-green: #16C784;
        --bear-red: #EA3943;
        --warn-amber: #F59E0B;
        --info-blue: #3B82F6;

        /* çŠ¶æ€åº•è‰² */
        --bull-bg: rgba(22, 199, 132, 0.16);
        --bear-bg: rgba(234, 57, 67, 0.16);

        /* é˜´å½± */
        --shadow-1: 0 6px 16px -2px rgba(0, 0, 0, 0.3);
        --glow-brand: 0 0 24px rgba(0, 213, 255, 0.32);

        /* å­—ä½“ */
        --font-h1: -apple-system-headline2, -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        --font-h2: -apple-system-headline1, -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        --font-h3: -apple-system-headline, -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        --font-title: -apple-system-headline, -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        --font-body: -apple-system-body, -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        --font-caption: -apple-system-caption1, -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;

        /* é—´è· */
        --space-xs: 4pt;
        --space-sm: 8pt;
        --space-md: 16pt;
        --space-lg: 24pt;
        --space-xl: 32pt;

        /* åœ†è§’ */
        --radius-chip: 12pt;
        --radius-card: 16pt;
        --radius-sheet: 20pt;
      }

      .mobile-app {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: var(--bg-primary);
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        animation: fadeInUp 0.3s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(12pt);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-md) var(--space-md);
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-base);
        min-height: 64pt;
      }

      .header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--space-xs);
      }

      .api-status {
        display: flex;
        align-items: center;
        gap: 6pt;
        font-family: var(--font-caption);
        font-size: 11pt;
        font-weight: 400;
        line-height: 15pt;
      }

      .status-dot {
        width: 8pt;
        height: 8pt;
        border-radius: 4pt;
        background: var(--text-muted);
        transition: background-color 0.3s ease;
      }

      .status-dot.online {
        background: var(--bull-green);
        box-shadow: 0 0 8pt rgba(22, 199, 132, 0.6);
      }

      .status-dot.offline {
        background: var(--bear-red);
        box-shadow: 0 0 8pt rgba(234, 57, 67, 0.6);
      }

      .status-text {
        color: var(--text-muted);
        font-size: 10pt;
      }

      .app-title {
        font-family: var(--font-h1);
        font-size: 28pt;
        font-weight: 600;
        line-height: 34pt;
        color: var(--text-primary);
        letter-spacing: -0.5pt;
      }

      .learning-stats {
        display: flex;
        gap: var(--space-sm);
      }

      .stat-item {
        text-align: center;
        min-width: 60pt;
      }

      .stat-label {
        font-family: var(--font-caption);
        font-size: 11pt;
        font-weight: 400;
        line-height: 15pt;
        color: var(--text-muted);
        margin-bottom: 2pt;
      }

      .stat-value {
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 600;
        line-height: 18pt;
        color: var(--brand-primary);
        font-variant-numeric: tabular-nums;
      }

      .timeframe-tabs {
        display: flex;
        padding: var(--space-md) var(--space-md);
        gap: var(--space-sm);
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-base);
      }

      .tf-tab {
        flex: 1;
        height: 36pt;
        background: var(--bg-surface-2);
        color: var(--text-secondary);
        border: none;
        border-radius: var(--radius-card);
        font-family: var(--font-title);
        font-size: 17pt;
        font-weight: 600;
        line-height: 22pt;
        cursor: pointer;
        transition: all 0.12s ease-out;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tf-tab:hover {
        background: var(--bg-surface);
        color: var(--text-primary);
      }

      .tf-tab.active {
        background: var(--brand-bg);
        color: var(--text-primary);
        box-shadow: var(--glow-brand);
        transform: scale(0.98);
        transition: transform 0.12s ease-out;
      }

      .tf-tab.active:active {
        transform: scale(1.0);
      }

      .mobile-content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 0 var(--space-md);
      }

      .tab-content {
        display: none;
        padding-bottom: var(--space-xl);
        min-height: 100%;
      }

      .tab-content.active {
        display: block;
      }

      /* ç¬¬ä¸€å—ï¼šå®æ—¶è¡Œæƒ… (iOSè§„èŒƒ) */
      .quotes-enhanced {
        background: var(--bg-surface);
        border-radius: var(--radius-card);
        overflow: hidden;
        border: 1px solid var(--border-base);
        max-height: 400pt;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        box-shadow: var(--shadow-1);
      }

      .quote-enhanced-item {
        display: flex;
        align-items: center;
        height: 56pt;
        padding: 0 12pt;
        border-bottom: 1px solid var(--border-base);
        transition: background-color 0.12s ease-out;
        cursor: pointer;
      }

      .quote-enhanced-item:last-child {
        border-bottom: none;
      }

      .quote-enhanced-item:active {
        background: rgba(255, 255, 255, 0.04);
      }

      .quote-symbol {
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 500;
        line-height: 22pt;
        color: var(--text-primary);
        min-width: 80pt;
      }

      .quote-price {
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 500;
        line-height: 22pt;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
        flex: 1;
        text-align: right;
        margin-right: 12pt;
      }

      .quote-change-chip {
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 400;
        line-height: 20pt;
        font-variant-numeric: tabular-nums;
        padding: 6pt 12pt;
        border-radius: 10pt;
        min-width: 72pt;
        text-align: center;
        margin-right: 12pt;
      }

      .quote-change-chip.positive {
        color: var(--bull-green);
        background: var(--bull-bg);
      }

      .quote-change-chip.negative {
        color: var(--bear-red);
        background: var(--bear-bg);
      }



      /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
      .quotes-enhanced::-webkit-scrollbar {
        width: 6px;
      }

      .quotes-enhanced::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 3px;
      }

      .quotes-enhanced::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #00d4ff, #0099cc);
        border-radius: 3px;
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
      }

      .quotes-enhanced::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #00ff88, #00d4ff);
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.7);
      }

      .market-section {
        margin-bottom: var(--space-lg);
        margin-top: var(--space-lg);
      }

      .section-title {
        font-family: var(--font-h3);
        font-size: 20pt;
        font-weight: 600;
        line-height: 26pt;
        margin-bottom: var(--space-md);
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        letter-spacing: -0.3pt;
      }

      /* ç¬¬äºŒå—ï¼šäº¤æ˜“ä¿¡å·å¡ç‰‡æ ·å¼ */
      .signals-section {
        margin-top: var(--space-lg);
      }

      .signals-disclaimer {
        font-family: var(--font-caption);
        font-size: 12pt;
        font-weight: 400;
        line-height: 16pt;
        color: var(--text-muted);
        text-align: center;
        margin-bottom: var(--space-md);
        padding: var(--space-sm) var(--space-md);
        background: rgba(148, 163, 184, 0.05);
        border-radius: var(--radius-chip);
        border: 1px solid rgba(148, 163, 184, 0.1);
      }

      .recommendation-section,
      .performance-section {
        margin-top: var(--space-lg);
      }

      .signals-cards {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
      }

      /* ç®¡ç†å®æ—¶ä¿¡å·æŒ‰é’® */
      .manage-signals-btn {
        height: 30pt;
        padding: 0 12pt;
        background: var(--brand-bg);
        color: var(--brand-primary);
        border: 1px solid var(--brand-primary-600);
        border-radius: var(--radius-chip);
        cursor: pointer;
      }

      .manage-tip {
        position: absolute;
        top: 48pt;
        right: 16pt;
        background: #111827;
        color: #e5e7eb;
        border: 1px solid #374151;
        border-radius: 8pt;
        padding: 8pt 10pt;
        font-size: 12pt;
        box-shadow: var(--shadow-1);
        z-index: 1200;
      }

      /* ç®¡ç†å®æ—¶ä¿¡å·æŠ½å±‰ */
      .ms-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 1800; display: flex; justify-content: flex-end; }
      .ms-drawer { width: min(88vw, 520pt); background: var(--bg-surface); border-left: 1px solid var(--border-base); padding: var(--space-md); overflow-y: auto; }
      .ms-header { display:flex; align-items:center; justify-content: space-between; margin-bottom: var(--space-sm); }
      .ms-title { font-size: 18pt; font-weight: 700; color: var(--text-primary); }
      .ms-actions { display:flex; gap: var(--space-sm); }
      .ms-btn { height: 32pt; padding: 0 12pt; border-radius: var(--radius-chip); border: 1px solid var(--border-base); background: var(--bg-surface-2); color: var(--text-secondary); cursor: pointer; }
      .ms-btn.primary { background: var(--brand-primary); color: #000; border-color: var(--brand-primary-600); }
      .ms-list { display: flex; flex-direction: column; gap: 8pt; margin-top: var(--space-sm); }
      .ms-item { display:flex; align-items:center; justify-content: space-between; padding: 10pt 12pt; background: var(--bg-surface-2); border: 1px solid var(--border-base); border-radius: var(--radius-chip); }
      .ms-switch { position: relative; width: 46px; height: 24px; background: #334155; border-radius: 12px; cursor:pointer; }
      .ms-switch.active { background: #00d4ff; }
      .ms-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; background: #fff; border-radius: 9px; transition: transform .2s ease; }
      .ms-switch.active::after { transform: translateX(22px); }

      /* å¿«é€Ÿå›æµ‹å¼¹çª—æ ·å¼ */
      .qb-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        z-index: 2000;
      }

      .qb-modal {
        width: 100%;
        max-width: 640pt;
        background: var(--bg-surface);
        border-top-left-radius: var(--radius-sheet);
        border-top-right-radius: var(--radius-sheet);
        border: 1px solid var(--border-base);
        box-shadow: var(--shadow-1);
        padding: var(--space-md);
        max-height: 80vh;
        overflow-y: auto;
        animation: fadeInUp 0.2s ease-out;
      }

      .qb-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-sm);
        margin-bottom: var(--space-sm);
      }

      .qb-title {
        font-family: var(--font-title);
        font-size: 17pt;
        font-weight: 700;
        color: var(--text-primary);
      }

      .qb-close {
        background: transparent;
        border: 1px solid var(--border-base);
        color: var(--text-secondary);
        border-radius: var(--radius-chip);
        padding: 6pt 10pt;
        cursor: pointer;
      }

      .qb-meta-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-sm);
        margin: var(--space-sm) 0 var(--space-md);
      }

      .qb-meta {
        text-align: center;
        background: var(--bg-surface-2);
        border: 1px solid var(--border-base);
        border-radius: var(--radius-chip);
        padding: 8pt;
      }

      .qb-label { color: var(--text-muted); font-size: 12pt; }
      .qb-value { color: var(--brand-primary); font-weight: 700; font-size: 16pt; }

      .qb-range-switch {
        display: flex;
        gap: var(--space-sm);
        margin-bottom: var(--space-sm);
      }

      .qb-range-btn {
        flex: 1;
        height: 30pt;
        background: var(--bg-surface-2);
        color: var(--text-secondary);
        border: 1px solid var(--border-base);
        border-radius: var(--radius-chip);
        cursor: pointer;
      }

      .qb-range-btn.active {
        background: var(--brand-bg);
        color: var(--text-primary);
        border-color: var(--brand-primary-600);
      }

      .qb-chart {
        height: 80pt;
        background: var(--bg-primary);
        border: 1px solid var(--border-base);
        border-radius: var(--radius-chip);
        margin-bottom: var(--space-md);
        position: relative;
        overflow: hidden;
      }

      .qb-chart-bar {
        position: absolute;
        bottom: 4pt;
        width: 4pt;
        background: linear-gradient(180deg, var(--brand-primary), #00a3cc);
        border-radius: 2pt;
      }

      .qb-table { width: 100%; border-collapse: collapse; }
      .qb-table th, .qb-table td { padding: 8pt; border-bottom: 1px solid var(--border-base); text-align: left; }
      .qb-empty, .qb-error, .qb-loading { text-align: center; color: var(--text-secondary); padding: var(--space-md) 0; }

      .signal-compact-card {
        background: var(--bg-surface);
        border-radius: var(--radius-card);
        padding: var(--space-md);
        border: 1px solid var(--border-base);
        box-shadow: var(--shadow-1);
        cursor: pointer;
        transition: background-color 0.12s ease-out;
        animation: slideInRight 0.3s ease-out;
        animation-fill-mode: both;
      }

      .signal-compact-card:active {
        background: rgba(255, 255, 255, 0.04);
      }

      .signal-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
      }

      .signal-title-compact {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
      }

      .signal-direction-pill {
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 600;
        line-height: 20pt;
        padding: 6pt 12pt;
        border-radius: var(--radius-chip);
        color: white;
      }

      .signal-direction-pill.buy {
        background: var(--bull-green);
      }

      .signal-direction-pill.sell {
        background: var(--bear-red);
      }

      .signal-symbol {
        font-family: var(--font-title);
        font-size: 17pt;
        font-weight: 600;
        line-height: 22pt;
        color: var(--text-primary);
      }

      .signal-strategy-chip {
        background: var(--bg-surface-2);
        color: var(--text-secondary);
        padding: 4pt 8pt;
        border-radius: var(--radius-chip);
        font-family: var(--font-caption);
        font-size: 12pt;
        font-weight: 400;
        line-height: 16pt;
      }

      .signal-mini-kline {
        width: 80pt;
        height: 40pt;
        background: var(--bg-surface-2);
        border-radius: var(--radius-chip);
        border: 1px solid var(--border-base);
        position: relative;
        overflow: hidden;
      }

      .kline-bar {
        position: absolute;
        bottom: 2pt;
        width: 3pt;
        border-radius: 1pt;
        transition: all 0.2s ease;
      }

      .kline-bar.bullish {
        background: var(--bull-green);
        box-shadow: 0 0 4pt rgba(22, 199, 132, 0.3);
      }

      .kline-bar.bearish {
        background: var(--bear-red);
        box-shadow: 0 0 4pt rgba(234, 57, 67, 0.3);
      }

      



      .signal-price-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: var(--space-sm);
        margin-bottom: var(--space-md);
      }

      .signal-price-cell {
        text-align: center;
        padding: var(--space-sm);
        background: var(--bg-surface-2);
        border-radius: var(--radius-chip);
        border: 1px solid var(--border-base);
      }

      .signal-price-label {
        font-family: var(--font-caption);
        font-size: 12pt;
        font-weight: 400;
        line-height: 16pt;
        color: var(--text-muted);
        margin-bottom: 4pt;
      }

      .signal-price-value {
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 500;
        line-height: 22pt;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
      }

      .signal-actions {
        display: flex;
        gap: var(--space-sm);
      }

      .signal-btn {
        flex: 1;
        height: 40pt;
        border: none;
        border-radius: var(--radius-chip);
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 600;
        line-height: 22pt;
        cursor: pointer;
        transition: opacity 0.12s ease-out;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .signal-btn:active {
        opacity: 0.7;
      }

      .signal-btn-primary {
        background: var(--brand-primary);
        color: #000;
      }

      .signal-btn-secondary {
        background: transparent;
        color: var(--brand-primary);
        border: 1px solid var(--brand-primary-600);
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(50px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* ç¬¬ä¸‰ã€å››ã€äº”å—æ ·å¼ */
      .strategy-education-section,
      .recommendation-section,
      .performance-section {
        margin-top: 32px;
      }

      .comparison-hint {
        text-align: center;
        padding: var(--space-lg) var(--space-md);
        color: var(--text-muted);
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 400;
        line-height: 22pt;
        background: var(--bg-surface);
        border-radius: var(--radius-card);
        border: 1px solid var(--border-base);
      }

      .recommendation-config-hint {
        background: linear-gradient(135deg, var(--brand-bg), rgba(0, 213, 255, 0.08));
        border: 1px solid rgba(0, 213, 255, 0.3);
        border-radius: var(--radius-card);
        padding: var(--space-md);
        margin-bottom: var(--space-md);
        cursor: pointer;
        transition: all 0.12s ease-out;
      }

      .recommendation-config-hint:active {
        background: rgba(0, 213, 255, 0.12);
        transform: scale(0.98);
      }

      .config-hint-content {
        display: flex;
        align-items: center;
        gap: var(--space-md);
      }

      .config-hint-icon {
        font-size: 24pt;
        width: 40pt;
        height: 40pt;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--brand-primary);
        border-radius: 20pt;
        flex-shrink: 0;
      }

      .config-hint-text {
        flex: 1;
      }

      .config-hint-title {
        font-family: var(--font-title);
        font-size: 17pt;
        font-weight: 600;
        line-height: 22pt;
        color: var(--text-primary);
        margin-bottom: 4pt;
      }

      .config-hint-desc {
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 400;
        line-height: 20pt;
        color: var(--text-secondary);
      }

      .config-hint-btn {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        padding: 8pt 16pt;
        background: var(--brand-primary);
        color: #000;
        border: none;
        border-radius: var(--radius-chip);
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 600;
        line-height: 20pt;
        cursor: pointer;
        transition: opacity 0.12s ease-out;
        flex-shrink: 0;
      }

      .config-hint-btn:active {
        opacity: 0.7;
      }

      .recommendation-cards {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
      }

      .recommendation-card {
        background: var(--bg-surface);
        border-radius: var(--radius-card);
        padding: var(--space-md);
        border: 1px solid var(--border-base);
        box-shadow: var(--shadow-1);
        transition: background-color 0.12s ease-out;
        cursor: pointer;
      }

      .recommendation-card:active {
        background: rgba(255, 255, 255, 0.04);
      }

      .recommendation-title {
        font-family: var(--font-title);
        font-size: 17pt;
        font-weight: 600;
        line-height: 22pt;
        color: var(--text-primary);
        margin-bottom: var(--space-sm);
      }

      .recommendation-content {
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 400;
        line-height: 20pt;
        color: var(--text-secondary);
        margin-bottom: var(--space-md);
      }

      .recommendation-actions {
        display: flex;
        gap: var(--space-sm);
      }

      .recommendation-meta {
        margin-bottom: var(--space-md);
      }

      .meta-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 32pt;
        border-bottom: 1px solid var(--border-base);
      }

      .meta-row:last-child {
        border-bottom: none;
      }

      .meta-label {
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 400;
        line-height: 20pt;
        color: var(--text-secondary);
      }

      .meta-value {
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 500;
        line-height: 20pt;
        color: var(--text-primary);
      }

      .backtest-results {
        background: var(--bg-surface-2);
        border-radius: var(--radius-chip);
        padding: var(--space-md);
        margin-bottom: var(--space-md);
        border: 1px solid var(--border-base);
      }

      .backtest-title {
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 600;
        line-height: 22pt;
        color: var(--text-primary);
        margin-bottom: var(--space-sm);
      }

      .backtest-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-sm);
      }

      .backtest-item {
        text-align: center;
        padding: var(--space-sm);
        background: var(--bg-primary);
        border-radius: var(--radius-chip);
        border: 1px solid var(--border-base);
      }

      .backtest-label {
        font-family: var(--font-caption);
        font-size: 12pt;
        font-weight: 400;
        line-height: 16pt;
        color: var(--text-muted);
        margin-bottom: 4pt;
      }

      .backtest-value {
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 600;
        line-height: 22pt;
        color: var(--brand-primary);
        font-variant-numeric: tabular-nums;
      }

      .recommendation-reason {
        background: var(--brand-bg);
        border-radius: var(--radius-chip);
        padding: var(--space-md);
        margin-bottom: var(--space-md);
        border: 1px solid rgba(0, 213, 255, 0.3);
      }

      .reason-title {
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 600;
        line-height: 20pt;
        color: var(--brand-primary);
        margin-bottom: var(--space-sm);
      }

      .reason-content {
        font-family: var(--font-body);
        font-size: 14pt;
        font-weight: 400;
        line-height: 20pt;
        color: var(--text-primary);
      }

      .performance-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-md);
      }

      .review-panel,
      .ranking-panel {
        background: var(--bg-surface);
        border-radius: var(--radius-card);
        padding: var(--space-md);
        border: 1px solid var(--border-base);
        box-shadow: var(--shadow-1);
      }

      .review-panel h4,
      .ranking-panel h4 {
        font-family: var(--font-title);
        font-size: 17pt;
        font-weight: 600;
        line-height: 22pt;
        color: var(--text-primary);
        margin-bottom: var(--space-md);
        text-align: center;
      }

      .review-item,
      .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 44pt;
        border-bottom: 1px solid var(--border-base);
      }

      .review-item:last-child,
      .ranking-item:last-child {
        border-bottom: none;
      }

      .review-symbol,
      .ranking-strategy {
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 500;
        line-height: 22pt;
        color: var(--text-primary);
      }

      .review-result {
        padding: 4pt 8pt;
        border-radius: var(--radius-chip);
        font-family: var(--font-caption);
        font-size: 12pt;
        font-weight: 600;
        line-height: 16pt;
      }

      .review-result.profit {
        background: var(--bull-bg);
        color: var(--bull-green);
      }

      .review-result.loss {
        background: var(--bear-bg);
        color: var(--bear-red);
      }

      .ranking-rate {
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 500;
        line-height: 22pt;
        font-variant-numeric: tabular-nums;
        color: var(--brand-primary);
      }

      .personal-settings {
        margin-bottom: var(--space-lg);
      }

      .personal-settings-actions {
        margin-top: var(--space-lg);
        margin-bottom: var(--space-xl);
        padding-top: var(--space-lg);
        border-top: 1px solid var(--border-base);
      }

      .personal-settings-actions .btn-primary {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-primary-600));
        color: #000;
        font-weight: 600;
        font-size: 17pt;
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-card);
        box-shadow: var(--glow-brand);
        transition: all 0.12s ease-out;
      }

      .personal-settings-actions .btn-primary:active {
        transform: scale(0.98);
        box-shadow: 0 0 16px rgba(0, 213, 255, 0.4);
      }

      .setting-item {
        margin-bottom: var(--space-md);
      }

      .setting-item label {
        display: block;
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 500;
        line-height: 22pt;
        color: var(--text-primary);
        margin-bottom: var(--space-sm);
      }

      .setting-item select,
      .setting-item input[type="number"] {
        width: 100%;
        height: 44pt;
        padding: 0 var(--space-md);
        background: var(--bg-surface-2);
        border: 1px solid var(--border-base);
        border-radius: var(--radius-chip);
        color: var(--text-primary);
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 400;
        line-height: 22pt;
        appearance: none;
        cursor: pointer;
      }

      .setting-item input[type="number"] {
        font-variant-numeric: tabular-nums;
      }

      .slider-container {
        display: flex;
        align-items: center;
        gap: var(--space-md);
      }

      .slider-container input[type="range"] {
        flex: 1;
        height: 4pt;
        background: var(--bg-surface-2);
        border: none;
        border-radius: 2pt;
        outline: none;
        -webkit-appearance: none;
        cursor: pointer;
      }

      .slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20pt;
        height: 20pt;
        background: var(--brand-primary);
        border-radius: 10pt;
        cursor: pointer;
        box-shadow: 0 2pt 8pt rgba(0, 0, 0, 0.2);
      }

      .slider-container span {
        font-family: var(--font-body);
        font-size: 16pt;
        font-weight: 500;
        line-height: 22pt;
        color: var(--brand-primary);
        font-variant-numeric: tabular-nums;
        min-width: 48pt;
        text-align: right;
      }

      .fade-in-item {
        animation: fadeInLeft 0.5s ease-out;
        animation-fill-mode: both;
      }

      @keyframes fadeInLeft {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .settings-panel {
        padding: 20px 0;
      }

      .settings-panel h3 {
        font-size: 24px;
        margin-bottom: 20px;
        color: #00d4ff;
        font-weight: 800;
      }

      .strategy-switches {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 40px;
      }

      .strategy-switch {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        background: #1e293b;
        border-radius: 16px;
        border: 1px solid #334155;
        min-height: 72px;
      }

      .strategy-name {
        font-size: 18px;
        font-weight: 700;
      }

      .toggle-switch {
        position: relative;
        width: 60px;
        height: 32px;
        background: #334155;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .toggle-switch.active {
        background: #00d4ff;
      }

      .toggle-switch::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 26px;
        height: 26px;
        background: white;
        border-radius: 13px;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }

      .toggle-switch.active::after {
        transform: translateX(28px);
      }

      .backtest-panel {
        background: #1e293b;
        padding: 24px;
        border-radius: 16px;
        border: 1px solid #334155;
      }

      .backtest-panel label {
        display: block;
        margin-bottom: 16px;
        font-weight: 700;
        font-size: 16px;
      }

      #lookahead-slider {
        width: 100%;
        height: 12px;
        background: #334155;
        border-radius: 6px;
        outline: none;
        margin-bottom: 16px;
        -webkit-appearance: none;
      }

      #lookahead-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: #00d4ff;
        border-radius: 12px;
        cursor: pointer;
      }

      .btn-primary {
        width: 100%;
        padding: 20px;
        background: linear-gradient(135deg, #00d4ff, #0099cc);
        color: #000;
        border: none;
        border-radius: 16px;
        font-size: 18px;
        font-weight: 800;
        margin-top: 20px;
        cursor: pointer;
        transition: transform 0.2s ease;
        min-height: 60px;
      }

      .btn-primary:active {
        transform: scale(0.98);
      }

      .bottom-nav {
        display: flex;
        background: var(--bg-surface);
        border-top: 1px solid var(--border-base);
        height: 56pt;
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -1px 0 var(--border-base);
      }

      .nav-btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        transition: color 0.12s ease-out;
        min-height: 44pt;
        gap: 2pt;
      }

      .nav-btn.active {
        color: var(--brand-primary);
      }

      .nav-icon {
        font-size: 24pt;
      }

      .nav-label {
        font-family: var(--font-caption);
        font-size: 12pt;
        font-weight: 400;
        line-height: 16pt;
      }

      /* mine å…¥å£ä¸çº¢ç‚¹ */
      #nav-mine { position: relative; }
      .mine-badge {
        position: absolute; top: -6px; left: 50%; transform: translateX(-50%);
        display: none;
        min-width: 18px; height: 18px; padding: 0 5px;
        border-radius: 999px; background: #ef4444; color: #fff;
        font-size: 12px; line-height: 18px; text-align: center;
        box-shadow: 0 0 0 2px #0f172a;
        pointer-events: none;
      }
      #nav-mine.pulse { animation: mine-pulse .3s ease; }
      @keyframes mine-pulse { 0%{transform:scale(1)} 50%{transform:scale(1.08)} 100%{transform:scale(1)} }

      /* ===== Mine UI enhancements ===== */
      .tag-list { display: flex; flex-wrap: wrap; gap: 8pt; margin: 6pt 0 10pt; }
      .tag { padding: 4pt 8pt; border-radius: 12pt; background: var(--bg-surface-2); border: 1px solid var(--border-base); color: var(--text-secondary); font-size: 12pt; }

      .card { background: var(--bg-surface); border: 1px solid var(--border-base); border-radius: 12pt; padding: 10pt; margin: 8pt 0; box-shadow: var(--shadow-1); }
      .card .row { display: flex; gap: 10pt; align-items: center; justify-content: space-between; color: var(--text-secondary); font-size: 12pt; margin: 4pt 0; }
      .card .row strong { color: var(--text-primary); font-size: 14pt; }
      .card .actions { display: flex; gap: 8pt; margin-top: 8pt; }
      .card .actions button { height: 30pt; padding: 0 12pt; border-radius: 12pt; border: 1px solid var(--border-base); background: var(--bg-surface-2); color: var(--text-secondary); cursor: pointer; }
      .card .actions button:disabled { opacity: .6; cursor: not-allowed; }

      /* Map existing mine elements to card look */
      #mine-queued .signal-card, #mine-open .signal-card, #mine-history .signal-card { background: var(--bg-surface); border: 1px solid var(--border-base); border-radius: 12pt; padding: 10pt; }
      #mine-queued .signal-header, #mine-open .signal-header { display:flex; align-items:center; justify-content: space-between; }
      #mine-queued .signal-details, #mine-open .signal-details { display:flex; flex-wrap:wrap; gap: 10pt; color: var(--text-secondary); font-size: 12pt; margin-top: 6pt; }
      #mine-queued .timeframe-btn, #mine-open .timeframe-btn { height: 30pt; padding: 0 12pt; border-radius: 12pt; border: 1px solid var(--border-base); background: var(--bg-surface-2); color: var(--text-secondary); cursor: pointer; }

      /* ===== Info Page ===== */
      .info-container { padding: 16px; }
      .info-toolbar { display: flex; flex-wrap: wrap; gap: 10pt; align-items: center; margin-bottom: 12px; }
      .toolbar-group { display:flex; flex-direction: column; gap: 4pt; }
      .toolbar-group label { font-size: 12pt; color: var(--text-secondary); }
      .toolbar-group select, .toolbar-group input { height: 30pt; border-radius: 8pt; border: 1px solid var(--border-base); background: var(--bg-surface-2); color: var(--text-primary); padding: 0 8pt; }
      .toolbar-btn { height: 30pt; padding: 0 12pt; border-radius: 10pt; border: 1px solid var(--border-base); background: var(--brand-bg); color: var(--brand-primary); cursor: pointer; }
      .info-grid { display: flex; flex-direction: column; gap: 12px; }
      .info-summary { border: 1px solid #1A2430; border-radius: 16px; background: #0E141B; padding: 14px; margin-bottom: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.35); }
      .info-main { display: flex; flex-direction: column; gap: 8pt; }
      .info-chart-controls { display: flex; align-items: center; gap: 8pt; }
      .info-radar { 
        width: 100%; 
        height: 400pt; 
        min-height: 400pt; 
        border: 1px solid #1A2430; 
        border-radius: 16px; 
        background: #0E141B; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        position: relative; 
        box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      }
      .info-radar-snapshot { 
        width: 100%; 
        min-height: 250pt; 
        height: 250pt; 
        border: 1px solid #1A2430; 
        border-radius: 16px; 
        background: #0E141B; 
        margin-bottom: 12px; 
        box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      }
      .info-detail { display: block; }
      .info-panel { background: var(--bg-surface); border: 1px solid var(--border-base); border-radius: 12pt; padding: 10pt; min-height: 200pt; }
      .panel-title { font-weight: 700; margin-bottom: 8pt; color: var(--text-primary); }
      .panel-body { color: var(--text-secondary); font-size: 12pt; }
      .info-placeholder { color: var(--text-secondary); }
      .info-tip { color: var(--text-muted); font-size: 12pt; margin: 6pt 0 8pt; }
      .info-loading { 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        color: var(--text-secondary); 
        background: rgba(0, 0, 0, 0.2);
        padding: 20px;
        border-radius: 12px;
        backdrop-filter: blur(4px);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        margin: 0;
        pointer-events: none;
      }
      
      /* å®è§‚æƒ…ç»ªä¸èµ„é‡‘åˆ†ç»„æ ·å¼ */
      .macro-factors-card {
        background: #0E141B;
        border: 1px solid #1A2430;
        border-radius: 16px;
        padding: 14px;
        margin: 12px 0;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      }
      
      .macro-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }
      
      .macro-card-title h3 {
        font-size: 15px;
        font-weight: 600;
        color: #E6EDF6;
        margin: 0 0 4px 0;
      }
      
      .macro-card-title p {
        font-size: 12px;
        color: #8FA0B3;
        margin: 0;
      }
      
      .macro-card-controls {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .time-range-selector {
        display: flex;
        background: #1A2430;
        border-radius: 999px;
        padding: 2px;
      }
      
      .range-btn {
        height: 28px;
        padding: 0 12px;
        border: none;
        background: transparent;
        color: #8FA0B3;
        font-size: 12px;
        font-weight: 500;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .range-btn.active {
        background: linear-gradient(135deg, #1FA2FF, #12D8FA, #A6FFCB);
        color: #0B0F14;
        font-weight: 600;
      }
      
      .range-btn:hover:not(.active) {
        color: #E6EDF6;
        background: rgba(255, 255, 255, 0.05);
      }
      
      .macro-chart-container {
        margin-bottom: 16px;
      }
      
      .macro-chart-container:last-child {
        margin-bottom: 0;
      }
      
      .chart-etf-fng {
        width: 100%;
        height: 340px;
        background: #0B0F14;
        border-radius: 12px;
        position: relative;
        border: 1px solid #121A22;
      }
      
      .chart-funding-heat {
        width: 100%;
        height: 400px;
        background: #0B0F14;
        border-radius: 12px;
        position: relative;
        border: 1px solid #121A22;
      }
      
      .chart-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #8FA0B3;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 12px;
      }
      
      .chart-loading .loading-spinner {
        width: 24px;
        height: 24px;
        border: 2px solid #1A2430;
        border-top: 2px solid #1FA2FF;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 8px;
      }
      
      .chart-loading .loading-text {
        font-size: 12px;
        color: #8FA0B3;
      }
      
      /* æ¨ªå±é€‚é… */
      @media (min-width: 768px) {
        .chart-etf-fng {
          height: 420px;
        }
        
        .chart-funding-heat {
          height: 480px;
        }
      }
      .loading-spinner { 
        width: 32px; height: 32px; border: 3px solid var(--border-base); 
        border-top: 3px solid var(--brand-primary); border-radius: 50%; 
        animation: spin 1s linear infinite; margin-bottom: 12px; 
      }
      .loading-text { font-size: 14px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      .fab-refresh {
        position: fixed;
        bottom: calc(80pt + env(safe-area-inset-bottom));
        right: var(--space-md);
        width: 44pt;
        height: 44pt;
        background: var(--brand-primary);
        border: none;
        border-radius: 22pt;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-1);
        cursor: pointer;
        transition: opacity 0.12s ease-out;
        z-index: 1000;
      }

      .fab-refresh:active {
        opacity: 0.7;
      }

      .refresh-icon {
        font-size: 20pt;
        color: #000;
      }

      .fab-refresh.spinning .refresh-icon {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      /* iPhoneå®‰å…¨åŒºåŸŸé€‚é… */
      @supports (padding: max(0px)) {
        .mobile-app {
          padding-top: max(44px, env(safe-area-inset-top));
        }

        .bottom-nav {
          padding-bottom: max(12px, calc(12px + env(safe-area-inset-bottom)));
        }

        .fab-refresh {
          bottom: max(110px, calc(110px + env(safe-area-inset-bottom)));
        }
      }
    `;

    document.head.appendChild(style);
  }

  private loadUserParamsFromStorage() {
    try {
      const raw = localStorage.getItem('user_profile_params');
      if (raw) {
        const p = JSON.parse(raw);
        if (typeof p === 'object' && p) {
          this.userParams = {
            profitTarget: Number(p.profitTarget ?? this.userParams.profitTarget),
            maxDrawdown: Number(p.maxDrawdown ?? this.userParams.maxDrawdown),
            riskExposure: Number(p.riskExposure ?? this.userParams.riskExposure),
            capitalSize: Number(p.capitalSize ?? this.userParams.capitalSize),
            monitoringFreq: String(p.monitoringFreq ?? this.userParams.monitoringFreq)
          };
          this.hasConfiguredFlag = true;
        }
      }
    } catch (_) {}
  }

  private setupMobileEventListeners() {
    // åº•éƒ¨å¯¼èˆª
    for (const btn of document.querySelectorAll('.nav-btn')) {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        const tab = target.getAttribute('data-tab');
        this.switchTab(tab || 'home');
      });
    }

    // æ—¶é—´å‘¨æœŸ
    for (const btn of document.querySelectorAll('.tf-tab')) {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        const tf = target.getAttribute('data-tf');
        if (tf) this.setTimeframe(tf);
      });
    }

    // ç®¡ç†å®æ—¶ä¿¡å·å…¥å£
    const manageBtn = document.getElementById('manage-signals-btn');
    if (manageBtn) {
      manageBtn.addEventListener('click', () => this.openManageSignals());
      // ä¸€æ¬¡æ€§æç¤ºæ°”æ³¡
      try {
        const tipKey = 'manage_signals_tip_shown';
        if (!localStorage.getItem(tipKey)) {
          const tip = document.createElement('div');
          tip.className = 'manage-tip';
          tip.textContent = 'ä½ å¯ä»¥åœ¨è¿™é‡Œé€‰æ‹©å¸‚åœºé¡µå±•ç¤ºå“ªäº›ç­–ç•¥çš„å®æ—¶ä¿¡å·ã€‚';
          document.querySelector('.mobile-header')?.appendChild(tip);
          setTimeout(() => tip.remove(), 3500);
          localStorage.setItem(tipKey, '1');
        }
      } catch (_) {}
    }

    // ç­–ç•¥å¼€å…³è¿ç§»è‡³"ç®¡ç†å®æ—¶ä¿¡å·"å…¥å£
    this.setupPersonalizationSliders();
    
    // è®¾ç½®é¡µä¸å†æä¾›ä¿å­˜ç­–ç•¥æŒ‰é’®

    const slider = document.getElementById('lookahead-slider') as HTMLInputElement;
    const value = document.getElementById('lookahead-value');
    if (slider && value) {
      slider.addEventListener('input', () => {
        value.textContent = slider.value;
      });
    }

    // Header æŒ‡æ ‡å¯ç‚¹å‡» -> è·³è½¬â€œæˆ‘çš„â€
    const ls = document.getElementById('learning-stats');
    if (ls && ls.getAttribute('data-clickable') === '1') {
      ls.addEventListener('click', () => this.switchTab('profile'));
    }

    // æˆ‘çš„é¡µâ€œç®¡ç†ç­–ç•¥â€å…¥å£
    document.getElementById('open-strategy-manager')?.addEventListener('click', () => this.openManageSignals());

    // Info page init on first switch
    const navInfo = Array.from(document.querySelectorAll('.nav-btn')).find(b => (b as HTMLElement).getAttribute('data-tab') === 'info');
    navInfo?.addEventListener('click', () => {
      if (!this.infoInited) {
        this.initInfoPage();
      }
    });

    // åˆå§‹åŒ–çº¢ç‚¹
    document.addEventListener('DOMContentLoaded', () => updateBadge());

    // ä¸€é”®æ¨¡æ‹Ÿçš„ç»Ÿä¸€ç›‘å¬ç”±ç¨³å®šç‰ˆå—æ³¨å†Œï¼Œè¿™é‡Œä¸é‡å¤ç»‘å®š
  }

  private initInfoPage() {
    this.infoInited = true;
    
    // Factor event bus
    this.infoEventBus = {
      emit: (event: string, data?: any) => {
        document.dispatchEvent(new CustomEvent(`factor:${event}`, { detail: data }));
      },
      on: (event: string, handler: (data?: any) => void) => {
        document.addEventListener(`factor:${event}`, (e: any) => handler(e.detail));
      }
    };
    
    // default toolbar values
    const assetSel = document.getElementById('info-asset') as HTMLSelectElement | null;
    const granSel = document.getElementById('info-granularity') as HTMLSelectElement | null;
    const dateInp = document.getElementById('info-date') as HTMLInputElement | null;
    if (assetSel && !assetSel.value) assetSel.value = 'BTC';
    if (granSel && !granSel.value) granSel.value = 'daily';
    
    // å¦‚æœEChartsè¿˜æ²¡åŠ è½½ï¼Œç­‰å¾…åŠ è½½å®Œæˆ
    if (!this.echartsMod) {
      console.log('[info] ECharts not ready, waiting...');
      // ç­‰å¾…é¢„åŠ è½½å®Œæˆ
      const checkECharts = () => {
        if (this.echartsMod) {
          this.initCharts();
        } else {
          setTimeout(checkECharts, 100);
        }
      };
      checkECharts();
    } else {
      this.initCharts();
    }
    
    // è®¾ç½®resizeå¤„ç†
    this.onInfoResize = () => { 
      try { 
        this.infoChart?.resize(); 
        // Also check if radar snapshot needs to be re-rendered
        setTimeout(() => this.renderInfoRadarSnapshot(), 100);
      } catch(_) {} 
    };
    window.addEventListener('resize', this.onInfoResize);
    
    // First data load
    this.refreshInfoData();
    
    // åˆå§‹åŒ–å®è§‚æ•°æ®ç»„ä»¶
    this.initMacroComponents();
    
    // Auto-show help on first visit
    try {
      if (!localStorage.getItem('info_help_shown')) {
        setTimeout(() => this.showInfoHelp(), 1000);
      }
    } catch(_) {}
    
    // bind toolbar events
    const refresh = () => this.refreshInfoData();
    assetSel?.addEventListener('change', refresh);
    granSel?.addEventListener('change', refresh);
    dateInp?.addEventListener('change', refresh);
    document.getElementById('info-export')?.addEventListener('click', () => this.exportInfoPNG());

    // help button
    const helpBtn = document.getElementById('info-help');
    helpBtn?.addEventListener('click', () => this.showInfoHelp());

    // keyboard controls
    document.addEventListener('keydown', (e) => {
      if (document.getElementById('info-view')?.classList.contains('active')) {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          const step = e.shiftKey ? 7 : 1;
          this.infoCurrentIdx = Math.max(0, this.infoCurrentIdx - step);
          this.renderInfoSummary();
          this.infoEventBus.emit('move:timestamp', this.infoCurrentIdx);
          this.pingIndexTail(this.infoCurrentIdx);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          const step = e.shiftKey ? 7 : 1;
          const max = Math.max(0, (this.infoIndex || []).length - 1);
          this.infoCurrentIdx = Math.min(max, this.infoCurrentIdx + step);
          this.renderInfoSummary();
          this.infoEventBus.emit('move:timestamp', this.infoCurrentIdx);
          this.pingIndexTail(this.infoCurrentIdx);
        }
      }
    });
    
    // Event bus listeners
    this.infoEventBus.on('move:timestamp', (idx: number) => {
      this.infoCurrentIdx = idx;
      this.renderInfoRadarSnapshot();
    });
    
    this.infoEventBus.on('select:factor', (factorKey: string | null) => {
      this.infoSelectedFactor = factorKey;
      this.renderInfoContribution();
    });
    
    this.infoEventBus.on('toggle:factor', (factorKey: string | null) => {
      this.infoSelectedFactor = factorKey;
      this.renderInfoContribution();
    });
  }
  
  private initMacroComponents() {
    // åˆå§‹åŒ–ETFÃ—FNGå¡ç‰‡çš„æ—¶é—´èŒƒå›´é€‰æ‹©å™¨
    const etfFngButtons = document.querySelectorAll('#card-etf-fng .range-btn');
    etfFngButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const range = target.getAttribute('data-range');
        if (range) {
          this.macroCurrentRange = range;
          // æ›´æ–°æ‰€æœ‰å¡ç‰‡çš„æŒ‰é’®çŠ¶æ€
          document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll(`[data-range="${range}"]`).forEach(b => b.classList.add('active'));
          // è§¦å‘æ•°æ®æ›´æ–°
          this.macroEventBus.emit('range-change', range);
          this.refreshMacroData();
        }
      });
    });
    
    // åˆå§‹åŒ–èµ„é‡‘è´¹ç‡å¡ç‰‡çš„æ—¶é—´èŒƒå›´é€‰æ‹©å™¨
    const fundingButtons = document.querySelectorAll('#card-funding-heat .range-btn');
    fundingButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const range = target.getAttribute('data-range');
        if (range) {
          this.macroCurrentRange = range;
          // æ›´æ–°æ‰€æœ‰å¡ç‰‡çš„æŒ‰é’®çŠ¶æ€
          document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll(`[data-range="${range}"]`).forEach(b => b.classList.add('active'));
          // è§¦å‘æ•°æ®æ›´æ–°
          this.macroEventBus.emit('range-change', range);
          this.refreshMacroData();
        }
      });
    });
    
    // ç›‘å¬äº‹ä»¶æ€»çº¿
    this.macroEventBus.on('focus-date', (date: string) => {
      this.highlightDateInCharts(date);
    });
    
    this.macroEventBus.on('range-change', (range: string) => {
      this.macroCurrentRange = range;
      this.refreshMacroData();
    });
    
    // åˆå§‹åŒ–å›¾è¡¨
    this.initMacroCharts();
    
    // åŠ è½½æ•°æ®
    this.refreshMacroData();
  }
  
  private initMacroCharts() {
    // ç­‰å¾…EChartsåŠ è½½å®Œæˆ
    if (!this.echartsMod) {
      setTimeout(() => this.initMacroCharts(), 100);
      return;
    }
    
    // åˆå§‹åŒ–ETFÃ—FNGå›¾è¡¨
    const etfFngEl = document.getElementById('chart-etf-fng');
    if (etfFngEl && !this.macroETFFNGChart) {
      this.macroETFFNGChart = this.echartsMod.init(etfFngEl);
    }
    
    // åˆå§‹åŒ–èµ„é‡‘è´¹ç‡çƒ­åŠ›å›¾
    const fundingEl = document.getElementById('chart-funding-heat');
    if (fundingEl && !this.macroFundingChart) {
      this.macroFundingChart = this.echartsMod.init(fundingEl);
    }
  }
  
  private async refreshMacroData() {
    try {
      console.log('[macro] Loading data for range:', this.macroCurrentRange);
      
      // å¹¶è¡ŒåŠ è½½ETFÃ—FNGæ•°æ®å’Œèµ„é‡‘è´¹ç‡æ•°æ®
      const [etfFngData, fundingData] = await Promise.allSettled([
        this.fetchETFFNGData(),
        this.fetchFundingData()
      ]);
      
      // å¤„ç†ETFÃ—FNGæ•°æ®
      if (etfFngData.status === 'fulfilled') {
        this.macroETFFNGData = etfFngData.value;
        this.renderETFFNGChart();
      } else {
        console.warn('[macro] ETFÃ—FNG data failed:', etfFngData.reason);
        this.showMacroError('chart-etf-fng', 'ETFæ•°æ®åŠ è½½å¤±è´¥');
      }
      
      // å¤„ç†èµ„é‡‘è´¹ç‡æ•°æ®
      if (fundingData.status === 'fulfilled') {
        this.macroFundingData = fundingData.value;
        this.renderFundingHeatmap();
      } else {
        console.warn('[macro] Funding data failed:', fundingData.reason);
        this.showMacroError('chart-funding-heat', 'èµ„é‡‘è´¹ç‡æ•°æ®åŠ è½½å¤±è´¥');
      }
      
    } catch (error) {
      console.error('[macro] Data loading failed:', error);
    }
  }
  
  private async fetchETFFNGData(): Promise<any[]> {
    // æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥è°ƒç”¨API
    const days = this.macroCurrentRange === '7D' ? 7 : this.macroCurrentRange === '30D' ? 30 : 90;
    const data = [];
    
    for (let i = days - 1; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      
      data.push({
        date: dateStr,
        etf_total_flow_usd: Math.random() * 200000000 - 100000000, // éšæœºETFæµå…¥
        fng_value: Math.random() * 100 // éšæœºFear&Greedå€¼
      });
    }
    
    return data;
  }
  
  private async fetchFundingData(): Promise<any> {
    // æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥è°ƒç”¨API
    const days = this.macroCurrentRange === '7D' ? 7 : this.macroCurrentRange === '30D' ? 30 : 90;
    const symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'XRPUSDT'];
    const exchanges = ['Binance', 'OKX'];
    
    const slots = [];
    for (let i = days - 1; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      slots.push(date.toISOString().split('T')[0]);
    }
    
    const rows = [];
    exchanges.forEach(exchange => {
      symbols.forEach(symbol => {
        const values = slots.map(() => (Math.random() - 0.5) * 0.001); // éšæœºèµ„é‡‘è´¹ç‡
        rows.push({
          key: `${exchange}-${symbol}`,
          values: values
        });
      });
    });
    
    return {
      range: this.macroCurrentRange,
      slots: slots,
      rows: rows,
      updated_at: new Date().toISOString()
    };
  }
  
  private renderETFFNGChart() {
    if (!this.macroETFFNGChart || !this.macroETFFNGData.length) return;
    
    const dates = this.macroETFFNGData.map(d => d.date);
    const etfFlows = this.macroETFFNGData.map(d => d.etf_total_flow_usd);
    const fngValues = this.macroETFFNGData.map(d => d.fng_value);
    
    // æ ¼å¼åŒ–Yè½´æ ‡ç­¾
    const formatYAxisLabel = (value: number) => {
      if (Math.abs(value) >= 1000000) {
        return (value / 1000000).toFixed(1) + 'M';
      } else if (Math.abs(value) >= 1000) {
        return (value / 1000).toFixed(0) + 'K';
      }
      return value.toFixed(0);
    };
    
    const option = {
      animation: true,
      animationDuration: 600,
      animationEasing: 'cubicOut',
      tooltip: {
        trigger: 'axis',
        backgroundColor: 'rgba(11, 15, 20, 0.95)',
        borderColor: '#1A2430',
        textStyle: { 
          color: '#E6EDF6',
          fontSize: 12,
          lineHeight: 18
        },
        formatter: (params: any[]) => {
          const date = params[0].axisValue;
          const etf = params.find(p => p.seriesName === 'ETFå‡€æµå…¥');
          const fng = params.find(p => p.seriesName === 'F&G');
          return `
            <div style="padding: 8px;">
              <div style="font-weight: 600; margin-bottom: 4px;">${date}</div>
              <div style="color: #22D39A;">â— ETFå‡€æµå…¥: $${(etf?.value || 0).toLocaleString()}</div>
              <div style="color: #1FA2FF;">â— F&G: ${fng?.value || 0}</div>
            </div>
          `;
        }
      },
      legend: {
        data: ['ETFå‡€æµå…¥', 'F&G'],
        textStyle: { color: '#E6EDF6' },
        top: 12,
        left: 'center',
        backgroundColor: 'transparent'
      },
      grid: {
        left: '3%',
        right: '4%',
        bottom: '8%',
        top: '15%',
        containLabel: true
      },
      xAxis: {
        type: 'category',
        data: dates,
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: { 
          color: '#8FA0B3',
          interval: Math.floor(dates.length / 4) // æœ€å¤šæ˜¾ç¤º4ä¸ªåˆ»åº¦
        },
        splitLine: { show: false }
      },
      yAxis: [
        {
          type: 'value',
          position: 'left',
          axisLine: { show: false },
          axisTick: { show: false },
          axisLabel: { 
            color: '#8FA0B3',
            formatter: formatYAxisLabel
          },
          splitLine: { 
            lineStyle: { 
              color: 'rgba(255,255,255,0.06)',
              type: 'solid'
            }
          },
          axisLine: {
            lineStyle: {
              color: 'rgba(255,255,255,0.12)',
              width: 1
            }
          }
        },
        {
          type: 'value',
          position: 'right',
          min: 0,
          max: 100,
          axisLine: { show: false },
          axisTick: { show: false },
          axisLabel: { 
            color: '#8FA0B3',
            formatter: '{value}'
          },
          splitLine: { show: false }
        }
      ],
      series: [
        {
          name: 'ETFå‡€æµå…¥',
          type: 'bar',
          yAxisIndex: 0,
          data: etfFlows,
          barWidth: '55%',
          itemStyle: {
            color: (params: any) => {
              return params.value >= 0 ? '#22D39A' : '#FF6B6B';
            },
            borderRadius: [6, 6, 0, 0]
          },
          emphasis: {
            itemStyle: {
              shadowBlur: 10,
              shadowColor: (params: any) => {
                return params.value >= 0 ? 'rgba(34,211,154,0.35)' : 'rgba(255,107,107,0.35)';
              }
            }
          },
          animationDelay: (idx: number) => idx * 20,
          animationEasing: 'easeOutBack',
          animationDuration: 220
        },
        {
          name: 'F&G',
          type: 'line',
          yAxisIndex: 1,
          data: fngValues,
          smooth: true,
          symbol: 'circle',
          symbolSize: 3.5,
          lineStyle: {
            color: {
              type: 'linear',
              x: 0, y: 0, x2: 1, y2: 0,
              colorStops: [
                { offset: 0, color: '#1FA2FF' },
                { offset: 0.5, color: '#12D8FA' },
                { offset: 1, color: '#A6FFCB' }
              ]
            },
            width: 2.5
          },
          itemStyle: {
            color: (params: any) => {
              const value = params.value;
              if (value < 25) return '#FF6B6B';
              if (value < 50) return '#FF8C42';
              if (value < 75) return '#FFD93D';
              return '#22D39A';
            },
            borderColor: '#CFFAF1',
            borderWidth: 1
          },
          emphasis: {
            itemStyle: {
              shadowBlur: 8,
              shadowColor: 'rgba(31,162,255,0.4)'
            }
          },
          animationDelay: (idx: number) => idx * 10,
          animationDuration: 600,
          animationEasing: 'cubicOut'
        }
      ]
    };
    
    this.macroETFFNGChart.setOption(option, true);
    
    // æ·»åŠ äº¤äº’äº‹ä»¶
    this.macroETFFNGChart.off('mouseover');
    this.macroETFFNGChart.on('mouseover', (params: any) => {
      if (params.componentType === 'series') {
        this.macroEventBus.emit('focus-date', dates[params.dataIndex]);
      }
    });
  }
  
  private renderFundingHeatmap() {
    if (!this.macroFundingChart || !this.macroFundingData) return;
    
    const { slots, rows } = this.macroFundingData;
    const data = [];
    
    rows.forEach((row: any, rowIndex: number) => {
      row.values.forEach((value: number, colIndex: number) => {
        data.push([colIndex, rowIndex, value]);
      });
    });
    
    const option = {
      animation: true,
      animationDuration: 200,
      animationEasing: 'cubicOut',
      tooltip: {
        position: 'top',
        backgroundColor: 'rgba(11, 15, 20, 0.95)',
        borderColor: '#1A2430',
        textStyle: { 
          color: '#E6EDF6',
          fontSize: 12,
          lineHeight: 18
        },
        formatter: (params: any) => {
          const row = rows[params.data[1]];
          const date = slots[params.data[0]];
          const rate = params.data[2];
          return `
            <div style="padding: 8px;">
              <div style="font-weight: 600; margin-bottom: 4px;">${date}</div>
              <div style="margin-bottom: 2px;">${row.key}</div>
              <div style="color: ${rate >= 0 ? '#2AC59E' : '#C9485B'};">
                èµ„é‡‘è´¹ç‡: ${(rate * 100).toFixed(4)}%
              </div>
            </div>
          `;
        }
      },
      grid: {
        left: '12%',
        right: '8%',
        bottom: '8%',
        top: '8%',
        containLabel: true
      },
      xAxis: {
        type: 'category',
        data: slots,
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: { 
          color: '#8FA0B3',
          interval: Math.floor(slots.length / 4)
        },
        splitLine: { show: false }
      },
      yAxis: {
        type: 'category',
        data: rows.map((r: any) => r.key),
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: { 
          color: '#8FA0B3',
          align: 'right'
        },
        splitLine: { show: false }
      },
      visualMap: {
        min: -0.001,
        max: 0.001,
        calculable: true,
        orient: 'horizontal',
        left: 'right',
        top: '5%',
        width: 20,
        height: 200,
        inRange: {
          color: ['#C9485B', '#2A3442', '#2AC59E']
        },
        textStyle: { 
          color: '#8FA0B3',
          fontSize: 10
        },
        formatter: (value: number) => {
          return (value * 100).toFixed(2) + '%';
        }
      },
      series: [{
        type: 'heatmap',
        data: data,
        label: {
          show: false
        },
        itemStyle: {
          borderRadius: 3,
          borderWidth: 0
        },
        emphasis: {
          itemStyle: {
            shadowBlur: 8,
            shadowColor: 'rgba(0, 0, 0, 0.3)',
            borderWidth: 1,
            borderColor: '#1FA2FF'
          }
        },
        animationDelay: (idx: number) => idx * 2,
        animationDuration: 200
      }]
    };
    
    this.macroFundingChart.setOption(option, true);
    
    // æ·»åŠ äº¤äº’äº‹ä»¶
    this.macroFundingChart.off('click');
    this.macroFundingChart.on('click', (params: any) => {
      if (params.componentType === 'series') {
        const date = slots[params.data[0]];
        this.macroEventBus.emit('focus-date', date);
      }
    });
    
    // æ·»åŠ æ‚¬åœäº‹ä»¶
    this.macroFundingChart.off('mouseover');
    this.macroFundingChart.on('mouseover', (params: any) => {
      if (params.componentType === 'series') {
        const date = slots[params.data[0]];
        this.macroEventBus.emit('focus-date', date);
      }
    });
  }
  
  private highlightDateInCharts(date: string) {
    // åœ¨ä¸¤ä¸ªå›¾è¡¨ä¸­é«˜äº®æŒ‡å®šæ—¥æœŸ
    if (this.macroETFFNGChart) {
      const option = this.macroETFFNGChart.getOption();
      // æ·»åŠ å‚è€ƒçº¿é€»è¾‘
    }
    
    if (this.macroFundingChart) {
      const option = this.macroFundingChart.getOption();
      // æ·»åŠ é«˜äº®é€»è¾‘
    }
  }
  
  private showMacroError(chartId: string, message: string) {
    const chartEl = document.getElementById(chartId);
    if (chartEl) {
      chartEl.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #8FA0B3;">
          <div style="font-size: 14px; margin-bottom: 8px;">âš ï¸</div>
          <div style="font-size: 12px;">${message}</div>
        </div>
      `;
    }
  }
  
  private async refreshMacroData() {
    try {
      // å¹¶è¡ŒåŠ è½½ETFÃ—FNGæ•°æ®å’Œèµ„é‡‘è´¹ç‡æ•°æ®
      const [etfFngData, fundingData] = await Promise.allSettled([
        this.fetchETFFNGData(),
        this.fetchFundingData()
      ]);
      
      // å¤„ç†ETFÃ—FNGæ•°æ®
      if (etfFngData.status === 'fulfilled') {
        this.macroETFFNGData = etfFngData.value;
        this.renderETFFNGChart();
      }
      
      // å¤„ç†èµ„é‡‘è´¹ç‡æ•°æ®
      if (fundingData.status === 'fulfilled') {
        this.macroFundingData = fundingData.value;
        this.renderFundingHeatmap();
      }
      
    } catch (error) {
      console.error('[macro] Data loading failed:', error);
    }
  }
  
  private async fetchETFFNGData(): Promise<any[]> {
    // æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥è°ƒç”¨API
    const days = this.macroCurrentRange === '7D' ? 7 : this.macroCurrentRange === '30D' ? 30 : 90;
    const data = [];
    
    for (let i = days - 1; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      
      data.push({
        date: dateStr,
        etf_total_flow_usd: Math.random() * 200000000 - 100000000, // éšæœºETFæµå…¥
        fng_value: Math.random() * 100 // éšæœºFear&Greedå€¼
      });
    }
    
    return data;
  }
  
  private async fetchFundingData(): Promise<any> {
    // æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥è°ƒç”¨API
    const days = this.macroCurrentRange === '7D' ? 7 : this.macroCurrentRange === '30D' ? 30 : 90;
    const symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'XRPUSDT'];
    const exchanges = ['Binance', 'OKX'];
    
    const slots = [];
    const rows = [];
    
    // ç”Ÿæˆæ—¶é—´æ§½
    for (let i = days - 1; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      slots.push(date.toISOString().split('T')[0]);
    }
    
    // ç”Ÿæˆæ•°æ®è¡Œ
    exchanges.forEach(exchange => {
      symbols.forEach(symbol => {
        const values = slots.map(() => (Math.random() - 0.5) * 0.001); // éšæœºèµ„é‡‘è´¹ç‡
        rows.push({
          key: `${exchange}-${symbol}`,
          values: values
        });
      });
    });
    
    return {
      range: this.macroCurrentRange,
      slots: slots,
      rows: rows,
      updated_at: new Date().toISOString()
    };
  }

  private async refreshInfoData() {
    const assetSel = document.getElementById('info-asset') as HTMLSelectElement | null;
    const granSel = document.getElementById('info-granularity') as HTMLSelectElement | null;
    const dateInp = document.getElementById('info-date') as HTMLInputElement | null;
    const tip = document.getElementById('info-tip');
    const asset = (assetSel?.value || 'BTC').toUpperCase();
    const gran = (granSel?.value || 'daily').toLowerCase();
    const date = dateInp?.value || '';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const loadingEl = document.getElementById('info-loading');
    if (loadingEl) {
      loadingEl.style.display = 'flex !important';
      loadingEl.style.zIndex = '9999';
      loadingEl.style.position = 'absolute';
      loadingEl.style.top = '50%';
      loadingEl.style.left = '50%';
      loadingEl.style.transform = 'translate(-50%, -50%)';
      // æ›´æ–°åŠ è½½æ–‡æœ¬ä¸º"è®¡ç®—ä¸­"
      const loadingText = loadingEl.querySelector('.loading-text');
      if (loadingText) loadingText.textContent = 'è®¡ç®—ä¸­...';
    }
    
    try {
      // å¹¶è¡Œè·å–æ•°æ®ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´
      const [factorsRes, indexRes] = await Promise.allSettled([
        useFactorsData({ asset, granularity: gran, date }),
        useFactorIndex({ asset, granularity: gran, days: 60, alpha: 0.3 })
      ]);

      // å¤„ç†å› å­æ•°æ®
      if (factorsRes.status === 'fulfilled') {
        this.infoData = factorsRes.value.data || [];
        this.infoAsOf = factorsRes.value.asOf || '';
        if (tip) tip.textContent = factorsRes.value.source === 'api' ? 'æ•°æ®æºï¼šå…¬å¼€APIï¼ˆ10åˆ†é’Ÿç¼“å­˜ï¼‰' : 'å®æ—¶æ•°æ®ä¸å¯ç”¨ï¼Œå·²å›é€€è‡³æœ¬åœ°æ ·æœ¬';
      } else {
        this.infoData = [];
        if (tip) tip.textContent = 'å®æ—¶æ•°æ®ä¸å¯ç”¨ï¼Œå·²å›é€€è‡³æœ¬åœ°æ ·æœ¬';
      }

      // å¤„ç†æŒ‡æ•°æ•°æ®
      if (indexRes.status === 'fulfilled') {
        this.infoIndex = indexRes.value.index || [];
        this.infoContrib = indexRes.value.contrib || [];
      } else {
        this.infoIndex = [];
        this.infoContrib = [];
      }

      // ç«‹å³æ¸²æŸ“ï¼Œä¸ç­‰å¾…ECharts
      this.renderInfoDetail();
      
      // å¦‚æœEChartså·²åŠ è½½ï¼Œç«‹å³æ¸²æŸ“å›¾è¡¨
      if (this.echartsMod) {
        this.renderInfoRadar();
        this.renderInfoContribution();
        this.renderInfoRadarSnapshot();
        // éšè—åŠ è½½çŠ¶æ€
        if (loadingEl) {
          loadingEl.style.display = 'none';
          loadingEl.style.visibility = 'hidden';
          loadingEl.style.zIndex = '-1';
        }
      } else {
        // å¦åˆ™ç­‰å¾…EChartsåŠ è½½å®Œæˆ
        console.log('[info] Waiting for ECharts to load...');
        // ç­‰å¾…EChartsåŠ è½½å®Œæˆåéšè—åŠ è½½çŠ¶æ€
        const waitForECharts = () => {
          if (this.echartsMod) {
            this.renderInfoRadar();
            this.renderInfoContribution();
            this.renderInfoRadarSnapshot();
            if (loadingEl) {
              loadingEl.style.display = 'none';
              loadingEl.style.visibility = 'hidden';
              loadingEl.style.zIndex = '-1';
            }
          } else {
            setTimeout(waitForECharts, 100);
          }
        };
        waitForECharts();
      }
      
    } catch (error) {
      console.error('[info] Data loading error:', error);
      if (tip) tip.textContent = 'å®æ—¶æ•°æ®ä¸å¯ç”¨ï¼Œå·²å›é€€è‡³æœ¬åœ°æ ·æœ¬';
    }
  }

  private renderInfoRadar() {
    if (!this.infoChart || !this.echartsMod) return;
    const order: Array<'macro'|'policy'|'capital'|'geopolitics'|'onchain'|'sentiment'> = ['macro','policy','capital','geopolitics','onchain','sentiment'];
    const map: Record<string, Dimension> = {};
    this.infoData.forEach(d => { map[String(d.name)] = d; });
    const values = order.map(k => (map[k]?.score ?? 0));
    const indicators = order.map(k => ({ name: k, max: 100 }));
    const selected = this.infoSelectedKey;
    const option: any = {
      tooltip: { formatter: (p: any) => {
        const arr = order.map(k => `${k}: ${map[k]?.score ?? '-'}`);
        return arr.join('<br/>');
      }},
      animation: true,
      animationDuration: 500,
      animationEasing: 'cubicOut',
      radar: {
        indicator: indicators,
        splitNumber: 5,
        axisName: { color: '#A7B1C2' },
        splitLine: { lineStyle: { color: '#1F2A3A' }},
        splitArea: { areaStyle: { color: ['transparent'] }},
        axisLine: { lineStyle: { color: '#1F2A3A' }}
      },
      series: [{
        type: 'radar',
        data: [{
          value: values,
          name: 'Factors',
          areaStyle: { 
            opacity: 0.35,
            shadowBlur: 10,
            shadowColor: 'rgba(106, 168, 255, 0.3)'
          },
          lineStyle: { 
            width: 3,
            shadowBlur: 8,
            shadowColor: 'rgba(106, 168, 255, 0.5)'
          },
          itemStyle: {
            shadowBlur: 6,
            shadowColor: 'rgba(106, 168, 255, 0.4)'
          }
        }]
      }]
    };
    this.infoChart.setOption(option, true);
    // click handling
    try {
      this.infoChart.off('click');
      this.infoChart.on('click', (params: any) => {
        // approximate: find max dimension as selected when clicked
        const vals = values.map((v, i) => ({ v: Number(v||0), i }));
        vals.sort((a,b)=>b.v-a.v);
        const idx = vals[0]?.i ?? 0;
        this.infoSelectedKey = order[idx];
        this.renderInfoDetail();
      });
    } catch(_) {}
  }

  private renderInfoDetail() {
    const panel = document.getElementById('info-detail-body');
    if (!panel) return;
    const d = this.infoData.find(x => String(x.name) === this.infoSelectedKey);
    if (!d) { panel.textContent = 'é€‰æ‹©å·¦ä¾§ç»´åº¦æŸ¥çœ‹è¯¦æƒ…'; return; }
    if (!d.sub_factors || !d.sub_factors.length) { panel.textContent = 'éƒ¨åˆ†æ•°æ®ç¼ºå¤±'; return; }
    const rows = d.sub_factors.map(sf => {
      const score = sf.score == null ? '-' : String(sf.score);
      const w = (sf.weight ?? 0).toFixed(2);
      const sig = sf.signal ?? '-';
      const notes = sf.notes ? String(sf.notes).slice(0, 80) : '';
      return `<tr><td>${sf.key}</td><td>${score}</td><td>${w}</td><td>${sig}</td><td title="${sf.notes||''}">${notes}</td></tr>`;
    }).join('');
    panel.innerHTML = `
      <table class="qb-table" style="width:100%;border-collapse:collapse;">
        <thead><tr><th>å­å› å­</th><th>åˆ†æ•°</th><th>æƒé‡</th><th>ä¿¡å·</th><th>å¤‡æ³¨</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  private renderInfoContribution() {
    const radarEl = document.getElementById('info-radar') as HTMLElement | null;
    if (!radarEl || !this.echartsMod) {
      console.log('[renderInfoContribution] Missing radarEl or echartsMod:', { radarEl: !!radarEl, echartsMod: !!this.echartsMod });
      return;
    }
    // å¤ç”¨åŒä¸€å®ä¾‹æ˜¾ç¤ºä¸»å›¾ï¼ˆç”¨ mixï¼šé¢ç§¯å †å  + æŒ‡æ•°çº¿ï¼‰
    if (!this.infoChart) {
      try { 
        this.infoChart = this.echartsMod.init(radarEl);
        console.log('[renderInfoContribution] Chart initialized:', this.infoChart);
      } catch(e) { 
        console.error('[renderInfoContribution] Chart init failed:', e);
        return; 
      }
    }
    const colors: Record<string, string> = {
      macro: '#6AA8FF', policy: '#8C7BFF', capital: '#50D4C2', geopolitics: '#F5A74A', onchain: '#5AD271', sentiment: '#FF7DAE'
    };
    const xData = (this.infoIndex || []).map(p => p.ts);
    const series: any[] = [];
    
    // 1) æŒ‡æ•°çº¿å‘å…‰è½¨è¿¹ï¼ˆåº•å±‚ï¼‰
    const idxVals = (this.infoIndex || []).map(p => p.smoothed ?? p.raw ?? null);
    series.push({
      name: 'index-glow',
      type: 'line',
      data: xData.map((t, i) => [t, idxVals[i] == null ? null : Number(idxVals[i])-50]),
      showSymbol: false,
      smooth: true,
      lineStyle: { 
        width: 8, 
        color: '#A0D2FF55', 
        shadowBlur: 20, 
        shadowColor: '#A0D2FF88',
        shadowOffsetY: 2
      },
      zlevel: 2,
      silent: true,
      tooltip: { show: false },
      animationDelay: (idx: number) => idx * 2
    });
    
    // 2) è´¡çŒ®å †å ï¼ˆç›¸å¯¹ 50 çš„åç§»ï¼‰
    for (const s of this.infoContrib || []) {
      const arr = (s.points || []).map(p => p.smoothed ?? p.raw ?? null);
      const isSelected = this.infoSelectedFactor === s.key;
      series.push({
        type: 'line', name: s.key, stack: 'contrib', smooth: true, showSymbol: false,
        data: xData.map((t, i) => [t, arr[i] == null ? null : Number(arr[i])]),
        areaStyle: { 
          opacity: isSelected ? 0.9 : 0.6, 
          color: { type: 'linear', x:0,y:0,x2:0,y2:1, colorStops:[{offset:0,color:(colors[s.key]||'#999')+'88'},{offset:1,color:(colors[s.key]||'#999')+'00'}] }
        },
        lineStyle: { 
          width: isSelected ? 2.5 : 1.5, 
          color: colors[s.key]||'#999',
          shadowBlur: isSelected ? 8 : 4,
          shadowColor: (colors[s.key]||'#999') + '66'
        },
        emphasis: { focus: 'series' },
        universalTransition: true,
        animationDelay: (idx: number) => idx * 10 + Math.random() * 20,
        animationDuration: 400 + Math.random() * 100
      });
    }
    
    // 3) æŒ‡æ•°çº¿ï¼ˆé¡¶å±‚ï¼‰
    series.push({
      name: 'index',
      type: 'line',
      data: xData.map((t, i) => [t, idxVals[i] == null ? null : Number(idxVals[i])-50]),
      showSymbol: true,
      symbol: 'circle',
      symbolSize: 5,
      smooth: true,
      lineStyle: { 
        width: 3, 
        color: '#A8E0FF',
        shadowBlur: 12,
        shadowColor: '#A8E0FF88',
        shadowOffsetY: 1
      },
      itemStyle: {
        shadowBlur: 6,
        shadowColor: '#A8E0FF66'
      },
      zlevel: 3,
      endLabel: { show: true, formatter: (params: any) => (Number(params.data[1]) + 50).toFixed(1) },
      animationDelay: (idx: number) => idx * 5,
      animationDuration: 500,
      // 6) æƒ…ç»ªèƒŒæ™¯è‰²å¸¦
      markArea: {
        silent: true,
        itemStyle: { opacity: 0.06 },
        data: [
          [{ yAxis: 0 }, { yAxis: 'max', itemStyle: { color: '#5AD271' } }], // ä¸ŠåŠ
          [{ yAxis: 'min' }, { yAxis: 0, itemStyle: { color: '#FF7DAE' } }]  // ä¸‹åŠ
        ]
      }
    });

    const option: any = {
      animation: true,
      animationDuration: 600,
      animationDurationUpdate: 300,
      animationEasing: 'cubicOut',
      animationEasingUpdate: 'cubicOut',
      tooltip: {
        trigger: 'axis', confine: true, backgroundColor: 'rgba(17,20,24,0.92)', borderWidth: 0,
        formatter: (params: any[]) => {
          const time = params?.[0]?.axisValueLabel || '';
          // æ”¶é›†è´¡çŒ®
          const items = params.filter(p => p.seriesName !== 'index' && p.seriesName !== 'index-glow').map(p => ({ name: p.seriesName, v: Number(p.data?.[1] ?? 0), c: p.color }));
          items.sort((a,b)=>Math.abs(b.v)-Math.abs(a.v));
          const top = items.slice(0,3); const bottom = items.slice(-3).reverse();
          const idxLine = params.find(p => p.seriesName==='index');
          const idxVal = Number((idxLine?.data?.[1] ?? 0) + 50).toFixed(1);
          const prevIdx = this.infoCurrentIdx > 0 ? Number((this.infoIndex[this.infoCurrentIdx-1]?.smoothed ?? this.infoIndex[this.infoCurrentIdx-1]?.raw ?? 50)) : Number(idxVal);
          const delta = (Number(idxVal) - prevIdx).toFixed(1);
          const row = (it:any)=>`<div style="display:flex;justify-content:space-between;gap:12px;"><span style="color:${it.c}">â—</span><span style="min-width:70px">${it.name}</span><span>${it.v>=0?'+':''}${it.v.toFixed(2)}</span></div>`;
          return `<div style="padding:6px 8px;">
            <div style="opacity:.8;margin-bottom:6px;">${time}</div>
            <div style="margin-bottom:6px;">ç»¼åˆæŒ‡æ•° B(t)ï¼š<b>${idxVal}</b> <span style="color:${Number(delta)>=0?'#16C784':'#EA3943'}">${Number(delta)>=0?'+':''}${delta}</span></div>
            <div style="opacity:.8;">TOP3 â†‘</div>${top.map(row).join('')}
            <div style="opacity:.8;margin-top:6px;">TOP3 â†“</div>${bottom.map(row).join('')}
          </div>`;
        }
      },
      legend: { 
        top: 0,
        selected: this.getLegendSelectedState()
      },
      grid: { left: 10, right: 10, bottom: 10, top: 30, containLabel: true },
      xAxis: { type: 'time' },
      yAxis: { 
        type: 'value', 
        name: 'è´¡çŒ®(ç›¸å¯¹50)', 
        min: -25, 
        max: 25, 
        splitLine: { lineStyle: { color: '#1F2A3A' } },
        axisLine: { lineStyle: { color: '#1F2A3A' } }
      },
      series
    };
    this.infoChart.setOption(option, true);
    console.log('[renderInfoContribution] Chart option set successfully', { 
      dataLength: this.infoIndex.length, 
      contribLength: this.infoContrib.length,
      seriesCount: series.length 
    });

    // æ·»åŠ äº‹ä»¶ç›‘å¬
    this.setupChartEventListeners();

    // set current index to latest
    const n = Math.max(0, (this.infoIndex || []).length - 1);
    if (this.infoCurrentIdx < 0) this.infoCurrentIdx = n;

    this.renderInfoSummary();
  }


  // 1) æŒ‡æ•°çº¿å°¾è¿¹é—ªçƒ
  private pingIndexTail(idx: number) {
    if (!this.infoChart || !this.infoIndex || idx < 0 || idx >= this.infoIndex.length) return;
    
    const point = this.infoIndex[idx];
    const tailPoint = [point.ts, (point.smoothed ?? point.raw ?? 50) - 50];
    
    this.infoChart.setOption({
      series: [{
        name: 'index',
        markPoint: {
          symbol: 'circle',
          symbolSize: 10,
          data: [{ coord: tailPoint }],
          itemStyle: { color: '#A8E0FF' },
          animationDuration: 300,
          animationEasing: 'cubicOut'
        }
      }]
    }, { replaceMerge: ['series'] });
    
    setTimeout(() => {
      this.infoChart?.setOption({ 
        series: [{ name: 'index', markPoint: { data: [] } }] 
      }, { replaceMerge: ['series'] });
    }, 320);
  }

  // 2) æ£€æµ‹è¿‡0è½´äº¤å‰
  private findZeroCrossings(indexArr: any[]) {
    const crossings: [string, number][] = [];
    for (let i = 1; i < indexArr.length; i++) {
      const a = (indexArr[i-1]?.smoothed ?? indexArr[i-1]?.raw ?? 50) - 50;
      const b = (indexArr[i]?.smoothed ?? indexArr[i]?.raw ?? 50) - 50;
      if ((a <= 0 && b > 0) || (a >= 0 && b < 0)) {
        crossings.push([indexArr[i].ts, 0]);
      }
    }
    return crossings;
  }

  // 4) Topè´¡çŒ®å‘¼å¸é«˜äº®
  private setBreathByPoint(params: any[], chart: any) {
    const items = params.filter(p => p.seriesName !== 'index' && p.seriesName !== 'index-glow');
    const sorted = items.sort((a, b) => Math.abs(b.data[1]) - Math.abs(a.data[1]));
    const topUp = sorted.filter(x => x.data[1] > 0).slice(0, 3).map(x => x.seriesName);
    const topDn = sorted.filter(x => x.data[1] < 0).slice(0, 3).map(x => x.seriesName);
    const focus = new Set([...topUp, ...topDn]);

    const series = chart.getOption().series.map((s: any) => {
      if (s.name === 'index' || s.name === 'index-glow') return s;
      const on = focus.has(s.name);
      return {
        ...s,
        areaStyle: { ...s.areaStyle, opacity: on ? 0.9 : 0.2 },
        lineStyle: { ...s.lineStyle, opacity: on ? 1 : 0.35 }
      };
    });
    chart.setOption({ series }, { lazyUpdate: true });
  }

  // å›¾ä¾‹é€‰æ‹©çŠ¶æ€ç®¡ç†
  private getLegendSelectedState() {
    const state: Record<string, boolean> = {};
    const order = ['macro', 'policy', 'capital', 'geopolitics', 'onchain', 'sentiment'];
    order.forEach(key => {
      state[key] = this.infoSelectedFactor === null || this.infoSelectedFactor === key;
    });
    return state;
  }

  // è®¾ç½®å›¾è¡¨äº‹ä»¶ç›‘å¬
  private setupChartEventListeners() {
    if (!this.infoChart) return;

    // 3) å›¾ä¾‹é€‰æ‹©å˜åŒ–
    this.infoChart.off('legendselectchanged');
    this.infoChart.on('legendselectchanged', (e: any) => {
      const series = this.infoChart.getOption().series.map((s: any) => 
        s.name === e.name ? { ...s, show: e.selected[e.name] } : s
      );
      this.infoChart.setOption({ series }, { notMerge: false, lazyUpdate: true });
    });

    // 4) é¼ æ ‡æ‚¬åœå‘¼å¸é«˜äº®
    this.infoChart.off('mouseover');
    this.infoChart.on('mouseover', (params: any) => {
      if (params.componentType === 'series') {
        this.setBreathByPoint([params], this.infoChart);
      }
    });

    // é¼ æ ‡ç¦»å¼€æ¢å¤
    this.infoChart.off('mouseout');
    this.infoChart.on('mouseout', () => {
      const series = this.infoChart.getOption().series.map((s: any) => {
        if (s.name === 'index' || s.name === 'index-glow') return s;
        return {
          ...s,
          areaStyle: { ...s.areaStyle, opacity: 0.6 },
          lineStyle: { ...s.lineStyle, opacity: 1 }
        };
      });
      this.infoChart.setOption({ series }, { lazyUpdate: true });
    });
  }


  private renderInfoSummary() {
    const wrap = document.getElementById('info-summary');
    if (!wrap) return;
    const n = (this.infoIndex || []).length;
    if (!n) { wrap.textContent = 'æš‚æ— æ•°æ®'; return; }
    const i = Math.max(0, Math.min(n-1, this.infoCurrentIdx < 0 ? n-1 : this.infoCurrentIdx));
    const idxVal = this.infoIndex[i];
    const b = Number((idxVal.smoothed ?? idxVal.raw ?? 50)).toFixed(1);
    // è¿‘7æ—¥å˜åŒ–
    const j = Math.max(0, i - 7);
    const bPrev = Number((this.infoIndex[j].smoothed ?? this.infoIndex[j].raw ?? 50));
    const delta = (Number(b) - bPrev).toFixed(1);
    // æœ€å¼º/æœ€å¼±å› å­
    const keys = ['macro','policy','capital','geopolitics','onchain','sentiment'];
    const dayContrib = keys.map(k => {
      const s = (this.infoContrib.find(c => c.key===k)?.points || [])[i];
      const v = Number(s?.smoothed ?? s?.raw ?? 0);
      return { k, v };
    });
    dayContrib.sort((a,b)=>b.v-a.v);
    const strongest = dayContrib[0];
    dayContrib.sort((a,b)=>a.v-b.v);
    const weakest = dayContrib[0];

    wrap.innerHTML = `
      <div style="display:flex;flex-wrap:wrap;gap:10pt;align-items:center;">
        <div>ç»¼åˆåˆ† B(t)ï¼š<span style="font-weight:700;color:#00D5FF">${b}</span></div>
        <div>7æ—¥å˜åŒ–ï¼š<span style="color:${Number(delta)>=0?'#16C784':'#EA3943'}">${Number(delta)>=0? 'â†‘':'â†“'} ${Math.abs(Number(delta)).toFixed(1)}</span></div>
        <div>æœ€å¼ºï¼š<b>${strongest?.k || '-'}</b></div>
        <div>æœ€å¼±ï¼š<b>${weakest?.k || '-'}</b></div>
      </div>`;
  }

  private renderInfoRadarSnapshot() {
    const el = document.getElementById('info-radar-snapshot') as HTMLElement | null;
    if (!el) {
      console.log('[radar-snapshot] Element not found');
      return;
    }
    
    // Check if element has dimensions
    const computedStyle = window.getComputedStyle(el);
    const isVisible = computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden';
    
    if (!isVisible || el.offsetWidth === 0 || el.offsetHeight === 0) {
      console.log('[radar-snapshot] Element not ready, waiting for layout', { 
        width: el.offsetWidth, 
        height: el.offsetHeight,
        display: computedStyle.display,
        visibility: computedStyle.visibility,
        isVisible,
        windowWidth: window.innerWidth
      });
      
      // If window is too small, show message but still try to render
      if (window.innerWidth < 1200) {
        console.log('[radar-snapshot] Window small, but forcing sidebar display');
      }
      
      // Retry after a short delay
      setTimeout(() => this.renderInfoRadarSnapshot(), 100);
      return;
    }
    
    if (!this.echartsMod) {
      console.log('[radar-snapshot] ECharts module not loaded yet');
      // Show placeholder text
      el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;font-size:14px;">é›·è¾¾å¿«ç…§åŠ è½½ä¸­...</div>';
      return;
    }
    
    // Dispose existing chart if any
    if (this.echartsMod.getInstanceByDom) {
      const existingChart = this.echartsMod.getInstanceByDom(el);
      if (existingChart) {
        existingChart.dispose();
      }
    }
    
    let chart: any = null;
    try {
      chart = this.echartsMod.init(el);
      console.log('[radar-snapshot] Chart initialized', { 
        dataLength: this.infoData.length,
        elementSize: { width: el.offsetWidth, height: el.offsetHeight }
      });
    } catch(e) { 
      console.log('[radar-snapshot] Chart init failed', e);
      el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">é›·è¾¾å¿«ç…§åˆå§‹åŒ–å¤±è´¥</div>';
      return; 
    }

    const order: string[] = ['macro','policy','capital','geopolitics','onchain','sentiment'];
    const i18n: Record<string, string> = {
      macro: 'å®è§‚', policy: 'æ”¿ç­–', capital: 'èµ„é‡‘', geopolitics: 'åœ°ç¼˜', onchain: 'é“¾ä¸Š', sentiment: 'æƒ…ç»ª'
    };
    
    const values: number[] = [];
    const indicators: any[] = [];
    const wowMap = new Map<string, number | null>();
    
    // Build data from current infoData
    console.log('[radar-snapshot] Building data from infoData:', this.infoData);
    
    // If no data, use test data
    if (!this.infoData || this.infoData.length === 0) {
      console.log('[radar-snapshot] No data, using test data');
      for (const k of order) {
        values.push(Math.random() * 100);
        wowMap.set(k, Math.random() * 10 - 5);
        const arrow = this.arrowByWow(k, wowMap.get(k) ?? null);
        indicators.push({ 
          name: i18n[k] + arrow, 
          max: 100 
        });
      }
    } else {
      for (const k of order) {
        const d = this.infoData.find(x => String(x.name) === k);
        const score = d?.score ?? null;
        const wow = d?.wow ?? null;
        values.push(score == null ? 0 : Number(score));
        wowMap.set(k, wow);
        
        console.log(`[radar-snapshot] Factor ${k}:`, { score, wow, found: !!d });
        
        // Build indicator with wow arrow
        const arrow = this.arrowByWow(k, wow);
        indicators.push({ 
          name: i18n[k] + arrow, 
          max: 100 
        });
      }
    }
    
    console.log('[radar-snapshot] Final values:', values);
    console.log('[radar-snapshot] Final indicators:', indicators);

    // Simple test configuration first
    const option: any = {
      animation: true,
      animationDuration: 500,
      animationEasing: 'cubicOut',
      radar: {
        indicator: indicators,
        splitNumber: 5,
        axisName: { color: '#666', fontSize: 12 },
        splitLine: { lineStyle: { color: '#ddd' } },
        splitArea: { show: false },
        axisLine: { lineStyle: { color: '#ddd' } }
      },
      series: [{
        type: 'radar',
        data: [{
          value: values,
          name: 'Factors',
          areaStyle: { 
            opacity: 0.4, 
            color: '#00D5FF',
            shadowBlur: 8,
            shadowColor: 'rgba(0, 213, 255, 0.3)'
          },
          lineStyle: { 
            width: 3, 
            color: '#00D5FF',
            shadowBlur: 6,
            shadowColor: 'rgba(0, 213, 255, 0.5)'
          },
          symbol: 'circle',
          symbolSize: 5,
          itemStyle: { 
            color: '#00D5FF',
            shadowBlur: 4,
            shadowColor: 'rgba(0, 213, 255, 0.4)'
          }
        }]
      }]
    };
    
    try {
      chart.setOption(option, true);
      console.log('[radar-snapshot] Chart option set successfully', { values, indicators: indicators.length });
      
      // Add resize listener
      const resizeHandler = () => {
        try {
          chart.resize();
        } catch(e) {
          console.log('[radar-snapshot] Resize failed:', e);
        }
      };
      window.addEventListener('resize', resizeHandler);
      
      // Store chart reference for cleanup
      (el as any)._radarChart = chart;
      (el as any)._radarResizeHandler = resizeHandler;
      
    } catch (error) {
      console.error('[radar-snapshot] Chart setOption failed:', error);
      el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#ff6b6b;font-size:14px;">é›·è¾¾å›¾æ¸²æŸ“å¤±è´¥</div>';
      return;
    }
    
    // Event handling
    chart.off('click');
    chart.off('mouseover');
    chart.off('mouseout');
    
    chart.on('click', (params: any) => {
      if (params.componentType === 'series' && params.seriesName === 'snapshot') {
        const factorKey = order[params.dataIndex];
        this.infoSelectedFactor = this.infoSelectedFactor === factorKey ? null : factorKey;
        this.infoEventBus.emit('toggle:factor', this.infoSelectedFactor);
        this.renderInfoContribution();
        
        // 5) é›·è¾¾æ‰‡åŒºå±•å¼€åŠ¨æ•ˆ
        this.animateRadarSector(chart, values, params.dataIndex, this.infoSelectedFactor === factorKey);
      }
    });
    
    chart.on('mouseover', (params: any) => {
      if (params.componentType === 'series' && params.seriesName === 'snapshot') {
        const factorKey = order[params.dataIndex];
        this.infoEventBus.emit('select:factor', factorKey);
      }
    });
    
    chart.on('mouseout', () => {
      this.infoEventBus.emit('select:factor', null);
    });
  }

  private arrowByWow(k: string, wow: number | null): string {
    if (wow == null) return '';
    if (wow > 1) return ' {up|â†‘}';
    if (wow < -1) return ' {down|â†“}';
    return ' {flat|â†’}';
  }

  private formatTimeLabel(ts?: string): string {
    if (!ts) return '';
    try {
      const d = new Date(ts);
      return d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    } catch(_) {
      return '';
    }
  }

  // 5) é›·è¾¾æ‰‡åŒºå±•å¼€åŠ¨æ•ˆ
  private animateRadarSector(chart: any, values: number[], selectedIdx: number, isSelected: boolean) {
    if (isSelected) {
      // åˆ›å»ºæ‰‡åŒºå¢å¼ºç³»åˆ—
      const sectorMask = (vals: number[], idx: number) => 
        vals.map((v, i) => i === idx ? v : Math.max(0.01, v * 0.01));
      
      const enhanced = {
        type: 'radar',
        name: 'sector-highlight',
        data: [{
          value: sectorMask(values, selectedIdx),
          name: 'Highlight',
          areaStyle: { opacity: 0.6 },
          lineStyle: { width: 3, color: '#A8E0FF' },
          symbol: 'circle',
          symbolSize: 6,
          itemStyle: { color: '#A8E0FF' }
        }],
        z: 5,
        animationDurationUpdate: 150
      };
      
      chart.setOption({ series: [enhanced] }, { replaceMerge: ['series'] });
    } else {
      // ç§»é™¤æ‰‡åŒºå¢å¼ºç³»åˆ—
      chart.setOption({ 
        series: [{ name: 'sector-highlight', data: [] }] 
      }, { replaceMerge: ['series'] });
    }
  }

  private showInfoHelp() {
    const existing = document.getElementById('info-help-modal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'info-help-modal';
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7);
      display: flex; align-items: center; justify-content: center; z-index: 10000;
    `;
    
    modal.innerHTML = `
      <div style="background: var(--bg-surface); border: 1px solid var(--border-base); border-radius: 16pt; padding: 20pt; max-width: 500pt; margin: 20pt;">
        <h3 style="margin-bottom: 16pt; color: var(--text-primary);">ğŸ“Š è¯»å›¾æç¤º</h3>
        <div style="color: var(--text-secondary); line-height: 1.5;">
          <p><strong>ä¸Šæ–¹æŠ˜çº¿</strong> = ç»¼åˆæŒ‡æ•°ï¼ˆ>50 åå¤šï¼Œ<50 åç©ºï¼‰</p>
          <p><strong>å½©è‰²é¢ç§¯</strong> = å„å› å­è´¡çŒ®ï¼Œå‘ä¸Šæ¨é«˜/å‘ä¸‹æ‹–ç´¯</p>
          <p><strong>ä¸‹æ–¹é›·è¾¾</strong> = å½“å‰æ—¶é—´ç‚¹çš„ 6 ç»´å¿«ç…§ï¼Œç‚¹å‡»æ‰‡åŒºå¯é«˜äº®å¯¹åº”å› å­</p>
          <p><strong>æ—¶é—´æ§åˆ¶</strong>ï¼šæ‹–åŠ¨æ»‘å—æˆ–ä½¿ç”¨é”®ç›˜ â†/â†’ å•æ­¥ï¼ŒShift+â†/â†’ è·³7å¤©</p>
        </div>
        <div style="margin-top: 16pt; text-align: right;">
          <button id="help-close" style="padding: 8pt 16pt; background: var(--brand-primary); color: #000; border: none; border-radius: 8pt; cursor: pointer;">çŸ¥é“äº†</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('help-close')?.addEventListener('click', () => {
      modal.remove();
      try { localStorage.setItem('info_help_shown', '1'); } catch(_) {}
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }

  private async exportInfoPNG() {
    // Placeholder: can integrate html-to-image if available in project
    alert('å¯¼å‡ºåŠŸèƒ½å¾…æ¥å…¥ï¼ˆhtml-to-imageï¼‰ã€‚');
  }

  // ç®¡ç†å®æ—¶ä¿¡å·æŠ½å±‰
  private openManageSignals() {
    const existing = document.getElementById('ms-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'ms-overlay';
    overlay.className = 'ms-overlay';
    overlay.innerHTML = `
      <div class="ms-drawer">
        <div class="ms-header">
          <div class="ms-title">ç®¡ç†å®æ—¶ä¿¡å·</div>
          <div class="ms-actions">
            <button class="ms-btn" id="ms-select-all">å…¨é€‰</button>
            <button class="ms-btn" id="ms-unselect-all">å…¨ä¸é€‰</button>
            <button class="ms-btn primary" id="ms-save">ä¿å­˜</button>
          </div>
        </div>
        <div id="ms-list" class="ms-list">åŠ è½½ä¸­...</div>
      </div>`;

    document.body.appendChild(overlay);

    // ç‚¹å‡»é®ç½©å…³é—­
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.remove();
    });

    // æ‹‰å–é…ç½®å¹¶æ¸²æŸ“
    fetch(`${BASE_API}/api/config`).then(r => r.json()).then(cfg => {
      const data = cfg?.data || {};
      const names: Record<string, string> = data.strategy_names || {};
      const enabled: string[] = data.strategies || [];
      if (enabled.length) this.activeStrategies = new Set(enabled);

      const list = document.getElementById('ms-list');
      if (!list) return;
      list.innerHTML = Object.keys(names).map(key => {
        const on = this.activeStrategies.has(key) ? 'active' : '';
        const label = names[key] || key;
        const safe = key.replace(/[^a-zA-Z0-9_-]/g, '');
        return `<div class="ms-item"><span>${label} <span style="opacity:.6;font-size:11pt;">(${key})</span></span><div class="ms-switch ${on}" data-key="${key}" id="sw-${safe}"></div></div>`;
      }).join('');

      list.addEventListener('click', (e) => {
        const sw = (e.target as HTMLElement).closest('.ms-switch');
        if (!sw) return;
        const key = sw.getAttribute('data-key');
        if (!key) return;
        if (this.activeStrategies.has(key)) {
          this.activeStrategies.delete(key);
          sw.classList.remove('active');
        } else {
          this.activeStrategies.add(key);
          sw.classList.add('active');
        }
      });

      // å…¨é€‰/å…¨ä¸é€‰/ä¿å­˜
      document.getElementById('ms-select-all')?.addEventListener('click', () => {
        this.activeStrategies = new Set(Object.keys(names));
        for (const el of list.querySelectorAll('.ms-switch')) el.classList.add('active');
      });
      document.getElementById('ms-unselect-all')?.addEventListener('click', () => {
        this.activeStrategies.clear();
        for (const el of list.querySelectorAll('.ms-switch')) el.classList.remove('active');
      });
      document.getElementById('ms-save')?.addEventListener('click', async () => {
        try {
          const resp = await fetch(`${BASE_API}/api/strategies`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ strategies: Array.from(this.activeStrategies) })
          });
          if (!resp.ok) throw new Error('ä¿å­˜å¤±è´¥');
          const data = await resp.json();
          if (!data.success) throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
          overlay.remove();
          // ä¿å­˜åç«‹å³åˆ·æ–°å¸‚åœºé¡µä¿¡å·
          this.updateSignals();
        } catch (_) {
          alert('âŒ ä¿å­˜ç­–ç•¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
      });
    }).catch(() => {
      const list = document.getElementById('ms-list');
      if (list) list.textContent = 'åŠ è½½å¤±è´¥';
    });
  }

  // å¿«é€Ÿå›æµ‹é€»è¾‘
  private currentQuickBacktestDays = 30;
  private quickBacktestAbort: AbortController | null = null;

  private openQuickBacktest(symbol: string, strategy: string) {
    this.renderQuickBacktestModal(symbol, strategy);
    this.loadQuickBacktestData(symbol, strategy, this.currentQuickBacktestDays);
  }

  private closeQuickBacktest() {
    const overlay = document.getElementById('qb-overlay');
    overlay?.remove();
    if (this.quickBacktestAbort) {
      this.quickBacktestAbort.abort();
      this.quickBacktestAbort = null;
    }
  }

  private renderQuickBacktestModal(symbol: string, strategy: string) {
    const existing = document.getElementById('qb-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'qb-overlay';
    overlay.className = 'qb-modal-overlay';
    overlay.innerHTML = `
      <div class="qb-modal" role="dialog" aria-modal="true">
        <div class="qb-header">
          <div class="qb-title">${strategy} Â· ${symbol} Â· å¿«é€Ÿå›æµ‹ï¼ˆè¿‘30å¤©ï¼‰</div>
          <button class="qb-close" id="qb-close">å…³é—­</button>
        </div>
        <div class="qb-range-switch">
          <button class="qb-range-btn" data-days="7">7d</button>
          <button class="qb-range-btn active" data-days="30">30d</button>
          <button class="qb-range-btn" data-days="90">90d</button>
        </div>
        <div id="qb-content" class="qb-loading">åŠ è½½å›æµ‹â€¦</div>
      </div>
    `;

    document.body.appendChild(overlay);

    (overlay.querySelector('#qb-close') as HTMLElement)?.addEventListener('click', () => this.closeQuickBacktest());
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) this.closeQuickBacktest();
    });

    for (const btn of overlay.querySelectorAll('.qb-range-btn')) {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        const daysAttr = target.getAttribute('data-days') || '30';
        this.currentQuickBacktestDays = Number(daysAttr);
        for (const b of overlay.querySelectorAll('.qb-range-btn')) b.classList.remove('active');
        target.classList.add('active');
        const title = overlay.querySelector('.qb-title');
        if (title) title.textContent = `${strategy} Â· ${symbol} Â· å¿«é€Ÿå›æµ‹ï¼ˆè¿‘${this.currentQuickBacktestDays}å¤©ï¼‰`;
        this.loadQuickBacktestData(symbol, strategy, this.currentQuickBacktestDays);
      });
    }
  }

  private async loadQuickBacktestData(symbol: string, strategy: string, days: number) {
    const container = document.getElementById('qb-content');
    if (!container) return;
    container.className = 'qb-loading';
    container.textContent = 'åŠ è½½å›æµ‹â€¦';

    if (this.quickBacktestAbort) this.quickBacktestAbort.abort();
    this.quickBacktestAbort = new AbortController();

    try {
      const resp = await fetch(`${BASE_API}/api/backtest/${encodeURIComponent(symbol)}?days=${days}&strategy=${encodeURIComponent(strategy)}`, { signal: this.quickBacktestAbort.signal });
      if (!resp.ok) throw new Error('ç½‘ç»œé”™è¯¯');
      const payload = await resp.json();
      if (!payload.success) throw new Error(payload.error || 'è·å–å¤±è´¥');
      const data = payload.data || {};

      // æ„é€ å›¾è¡¨æ•°æ®ï¼ˆç®€å•æŸ±çŠ¶/æŠ˜çº¿æ¨¡æ‹Ÿï¼‰
      const bars = Array.from({ length: 30 }, (_, i) => {
        // ç®€å•æ ¹æ®èƒœç‡æ„é€ è¶‹åŠ¿
        const base = Math.max(0.3, Math.min(0.9, (data.winRate || 60) / 100));
        const noise = (Math.random() - 0.5) * 0.2;
        return Math.max(0.05, Math.min(1.0, base + noise));
      });

      // æœ€è¿‘Nç¬”æ ·ä¾‹ï¼ˆå‰ç«¯æ¨¡æ‹Ÿï¼‰
      const recent = Array.from({ length: 6 }, () => {
        const isBuy = Math.random() > 0.5;
        const pnl = (Math.random() * 6 - 2).toFixed(2); // -2% ~ +4%
        const holdH = Math.floor(Math.random() * 72) + 6;
        const now = new Date();
        const dt = new Date(now.getTime() - Math.floor(Math.random() * days) * 86400000);
        return {
          date: dt.toISOString().slice(0, 10),
          side: isBuy ? 'BUY' : 'SELL',
          entry: (Math.random() * 1000 + 10).toFixed(2),
          exit: (Math.random() * 1000 + 10).toFixed(2),
          pnl,
          hold: `${holdH}h`
        };
      });

      container.className = '';
      container.innerHTML = `
        <div class="qb-meta-row">
          <div class="qb-meta"><div class="qb-label">èƒœç‡</div><div class="qb-value">${data.winRate ?? '--'}%</div></div>
          <div class="qb-meta"><div class="qb-label">ç´¯è®¡æ”¶ç›Š</div><div class="qb-value">${Math.round(((data.profitLossRatio || 1.6) - 1) * 100)}%</div></div>
          <div class="qb-meta"><div class="qb-label">æœ€å¤§å›æ’¤</div><div class="qb-value">${data.maxDrawdown ?? '--'}%</div></div>
          <div class="qb-meta"><div class="qb-label">äº¤æ˜“æ¬¡æ•°</div><div class="qb-value">${data.trades ?? '--'}</div></div>
        </div>
        <div class="qb-chart" id="qb-chart"></div>
        <table class="qb-table">
          <thead>
            <tr><th>æ—¥æœŸ</th><th>æ–¹å‘</th><th>å…¥åœº</th><th>é€€å‡º</th><th>ç›ˆäº%</th><th>æŒä»“æ—¶é•¿</th></tr>
          </thead>
          <tbody>
            ${recent.map(r => `<tr><td>${r.date}</td><td>${r.side}</td><td>${r.entry}</td><td>${r.exit}</td><td>${r.pnl}%</td><td>${r.hold}</td></tr>`).join('')}
          </tbody>
        </table>
        <div style="margin-top: var(--space-md); text-align:center;">
          <button class="qb-close" onclick="document.getElementById('qb-overlay')?.remove()">å…³é—­</button>
        </div>
      `;

      const chart = document.getElementById('qb-chart');
      if (chart) {
        const width = chart.clientWidth || 300;
        const gap = 2;
        const barW = 4;
        bars.slice(-Math.floor(width / (barW + gap))).forEach((v, i) => {
          const el = document.createElement('div');
          el.className = 'qb-chart-bar';
          el.style.left = `${i * (barW + gap) + 6}px`;
          el.style.height = `${Math.floor(v * 70)}px`;
          chart.appendChild(el);
        });
      }
    } catch (e) {
      container.className = 'qb-error';
      container.textContent = 'å›æµ‹æ•°æ®è·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
    }
  }

  public switchTab(tab: string) {
    this.currentTab = (['home','vip','info','profile'].includes(tab) ? tab : 'home') as any;

    for (const btn of document.querySelectorAll('.nav-btn')) {
      btn.classList.remove('active');
      if (btn.getAttribute('data-tab') === this.currentTab) {
        btn.classList.add('active');
      }
    }

    for (const content of document.querySelectorAll('.tab-content')) {
      content.classList.remove('active');
    }
    if (this.currentTab === 'home') {
      document.getElementById('market-view')?.classList.add('active');
      this.updateQuotes();
      this.updateSignals();
      this.updateLearningStats();
    } else if (this.currentTab === 'info' || this.currentTab === 'å› å­') {
      document.getElementById('info-view')?.classList.add('active');
      if (!this.infoInited) this.initInfoPage();
      // ç«‹å³å¼€å§‹é¢„åŠ è½½æ•°æ®ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
      this.refreshInfoData();
      
      // Ensure radar snapshot renders after layout
      setTimeout(() => {
        this.renderInfoRadarSnapshot();
      }, 100);
    } else if (this.currentTab === 'vip') {
      document.getElementById('vip-view')?.classList.add('active');
    } else if (this.currentTab === 'profile') {
      document.getElementById('profile-view')?.classList.add('active');
      try { initMineUI(); } catch(_) {}
    }
  }

  private setTimeframe(tf: string) {
    this.currentTimeframe = tf;

    for (const btn of document.querySelectorAll('.tf-tab')) {
      btn.classList.remove('active');
      if (btn.getAttribute('data-tf') === tf) {
        btn.classList.add('active');
      }
    }

    this.updateCurrentView();
  }

  private setupStrategyToggles() { /* è¿ç§»è‡³"ç®¡ç†å®æ—¶ä¿¡å·"æŠ½å±‰ï¼Œä¸å†åœ¨è®¾ç½®é¡µæ¸²æŸ“ */ }

  private setupPersonalizationSliders() {
    // æ”¶ç›Šç›®æ ‡æ»‘æ¡
    const profitSlider = document.getElementById('profit-target') as HTMLInputElement;
    const profitValue = document.getElementById('profit-target-value');
    if (profitSlider && profitValue) {
      profitSlider.addEventListener('input', () => {
        profitValue.textContent = `${profitSlider.value}%`;
        // å»¶è¿Ÿæ›´æ–°æ¨èï¼Œé¿å…è¿‡äºé¢‘ç¹
        clearTimeout(this.updateTimer);
        this.updateTimer = setTimeout(() => this.updateRecommendations(), 300);
      });
    }

    // æœ€å¤§å›æ’¤æ»‘æ¡
    const drawdownSlider = document.getElementById('max-drawdown') as HTMLInputElement;
    const drawdownValue = document.getElementById('max-drawdown-value');
    if (drawdownSlider && drawdownValue) {
      drawdownSlider.addEventListener('input', () => {
        drawdownValue.textContent = `${drawdownSlider.value}%`;
        clearTimeout(this.updateTimer);
        this.updateTimer = setTimeout(() => this.updateRecommendations(), 300);
      });
    }

    // é£é™©æš´éœ²åº¦æ»‘æ¡
    const riskSlider = document.getElementById('risk-exposure') as HTMLInputElement;
    const riskValue = document.getElementById('risk-exposure-value');
    if (riskSlider && riskValue) {
      riskSlider.addEventListener('input', () => {
        riskValue.textContent = `${riskSlider.value}%`;
        clearTimeout(this.updateTimer);
        this.updateTimer = setTimeout(() => this.updateRecommendations(), 300);
      });
    }

    // æœ¬é‡‘è§„æ¨¡è¾“å…¥æ¡†
    const capitalInput = document.getElementById('capital-size') as HTMLInputElement;
    if (capitalInput) {
      capitalInput.addEventListener('input', () => {
        clearTimeout(this.updateTimer);
        this.updateTimer = setTimeout(() => this.updateRecommendations(), 500);
      });
    }

    // ç›¯ç›˜é¢‘ç‡é€‰æ‹©
    const monitoringSelect = document.getElementById('monitoring-frequency') as HTMLSelectElement;
    if (monitoringSelect) {
      monitoringSelect.addEventListener('change', () => {
        clearTimeout(this.updateTimer);
        this.updateTimer = setTimeout(() => this.updateRecommendations(), 100);
      });
    }
  }

  private async updateQuotes() {
    const container = document.getElementById('quotes-enhanced');
    if (!container) return;

    try {
      // è°ƒç”¨çœŸå®APIè·å–è¡Œæƒ…æ•°æ®
      const response = await fetch(`${BASE_API}/api/quotes`);
      if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');

      const result = await response.json();
      if (!result.success) throw new Error(result.error || 'æ•°æ®è·å–å¤±è´¥');

      const quotes = result.data;

      container.innerHTML = quotes.map((quote: ApiQuote, index: number) => `
        <div class="quote-enhanced-item fade-in-item" style="animation-delay: ${index * 0.05}s">
          <div class="quote-symbol">${quote.symbol}</div>
          <div class="quote-price">${this.formatPrice(quote.close)}</div>
          <div class="quote-change-chip ${quote.isPositive ? 'positive' : 'negative'}">
            ${quote.changePercent}
          </div>
        </div>
      `).join('');
    } catch (error) {
      console.error('è·å–è¡Œæƒ…æ•°æ®å¤±è´¥:', error);
      container.innerHTML = '<div style="padding:12px;color:#94a3b8;">è¡Œæƒ…åŠ è½½å¤±è´¥</div>';
    }
  }

  private updateQuotesFallback() {
    const container = document.getElementById('quotes-enhanced');
    if (!container) return;

    const quotes = Object.entries(this.basePrices).slice(0, 8).map(([symbol, basePrice]) => {
      const change = (Math.random() - 0.5) * 0.1;
      const close = basePrice * (1 + change);
      const changePercent = (change * 100).toFixed(2);

      return {
        symbol,
        close,
        changePercent: `${change >= 0 ? '+' : ''}${changePercent}%`,
        isPositive: change >= 0
      };
    });

    container.innerHTML = quotes.map((quote, index) => `
      <div class="quote-enhanced-item fade-in-item" style="animation-delay: ${index * 0.05}s">
        <div class="quote-symbol">${quote.symbol}</div>
        <div class="quote-price">${this.formatPrice(quote.close)}</div>
        <div class="quote-change-chip ${quote.isPositive ? 'positive' : 'negative'}">
          ${quote.changePercent}
        </div>
      </div>
    `).join('');
  }

  private async updateSignals() {
    const container = document.getElementById('signals-cards');
    if (!container) return;

    try {
      // è°ƒç”¨çœŸå®APIè·å–ä¿¡å·æ•°æ®
      const response = await fetch(`${BASE_API}/api/signals`);
      if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');

      const result = await response.json();
      if (!result.success) throw new Error(result.error || 'æ•°æ®è·å–å¤±è´¥');

      const signals = result.data || [];

      if (!Array.isArray(signals) || signals.length === 0) {
        container.innerHTML = '<div style="padding:12px;color:#94a3b8;text-align:center;">è¯¥å‘¨æœŸæš‚æ— ä¿¡å·</div>';
        return;
      }

      container.innerHTML = signals.map((signal: ApiSignal, index: number) => `
        <div class="signal-compact-card" style="animation-delay: ${index * 0.1}s">
          <div class="signal-header-compact">
            <div class="signal-title-compact">
              <div class="signal-direction-pill ${signal.side.toLowerCase()}">${signal.side}</div>
              <div class="signal-symbol">${signal.symbol}</div>
              
            </div>
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div class="signal-strategy-chip">${signal.strategy}</div>
            </div>
          </div>

          <div class="signal-price-grid">
            <div class="signal-price-cell">
              <div class="signal-price-label">å…¥åœº</div>
              <div class="signal-price-value">${this.formatPrice(signal.entry)}</div>
            </div>
            <div class="signal-price-cell">
              <div class="signal-price-label">ç›®æ ‡</div>
              <div class="signal-price-value">${this.formatPrice(signal.target)}</div>
            </div>
            <div class="signal-price-cell">
              <div class="signal-price-label">æ­¢æŸ</div>
              <div class="signal-price-value">${this.formatPrice(signal.stop)}</div>
            </div>
          </div>

          <div class="signal-actions">
            <button class="signal-btn signal-btn-primary" onclick="event.stopPropagation(); window.openQuickBacktest('${signal.symbol}', '${signal.strategy}')">å¿«é€Ÿå›æµ‹</button>
            <button class="signal-btn signal-btn-secondary btn-sim" data-symbol="${signal.symbol}" data-side="${signal.side}" data-strategy="${signal.strategy}" data-tf="${signal.tf}" data-entry="${signal.entry}" onclick="event.stopPropagation()">åŠ å…¥â€œæˆ‘çš„â€</button>
          </div>
        </div>
      `).join('');

      // æ·»åŠ å¤é€‰æ¡†å˜åŒ–ç›‘å¬å™¨
      setTimeout(() => {
        this.setupCompareCheckboxListeners();
      }, 100);

    } catch (error) {
      console.error('è·å–ä¿¡å·æ•°æ®å¤±è´¥:', error);
      container.innerHTML = '<div style="padding:12px;color:#94a3b8;">ä¿¡å·åŠ è½½å¤±è´¥</div>';
    }
  }

  private updateSignalsFallback() {
    const container = document.getElementById('signals-cards');
    if (!container) return;

    const signals = Array.from(this.activeStrategies).slice(0, 4).map((strategy, index) => {
      const symbols = Object.keys(this.basePrices);
      const symbol = symbols[index % symbols.length];
      const side = Math.random() > 0.5 ? 'BUY' : 'SELL';
      const basePrice = this.basePrices[symbol];
      const entry = basePrice * (1 + (Math.random() - 0.5) * 0.04);

      // è®¡ç®—ç›®æ ‡ä»·å’Œæ­¢æŸä»·
      let target: number;
      let stop: number;
      if (side === 'BUY') {
        target = entry * (1 + 0.02 + Math.random() * 0.02); // 2-4% æ­¢ç›ˆ
        stop = entry * (1 - 0.015 - Math.random() * 0.01); // 1.5-2.5% æ­¢æŸ
      } else {
        target = entry * (1 - 0.02 - Math.random() * 0.02); // 2-4% æ­¢ç›ˆ
        stop = entry * (1 + 0.015 + Math.random() * 0.01); // 1.5-2.5% æ­¢æŸ
      }

      return {
        symbol,
        strategy: this.getStrategyName(strategy),
        side,
        entry,
        target,
        stop,
        confidence: Math.floor(Math.random() * 30) + 40,
        tf: this.currentTimeframe,
        time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      };
    });

    container.innerHTML = signals.map((signal, index) => `
      <div class="signal-compact-card" style="animation-delay: ${index * 0.1}s">
        <div class="signal-header-compact">
          <div class="signal-title-compact">
            <div class="signal-direction-pill ${signal.side.toLowerCase()}">${signal.side}</div>
            <div class="signal-symbol">${signal.symbol}</div>
            
          </div>
          <div style="display: flex; align-items: center; gap: var(--space-sm);">
            <div class="signal-strategy-chip">${signal.strategy}</div>
            <div class="signal-mini-kline" id="kline-${index}"></div>
          </div>
        </div>

        <div class="signal-price-grid">
          <div class="signal-price-cell">
            <div class="signal-price-label">å…¥åœº</div>
            <div class="signal-price-value">${this.formatPrice(signal.entry)}</div>
          </div>
          <div class="signal-price-cell">
            <div class="signal-price-label">ç›®æ ‡</div>
            <div class="signal-price-value">${this.formatPrice(signal.target)}</div>
          </div>
          <div class="signal-price-cell">
            <div class="signal-price-label">æ­¢æŸ</div>
            <div class="signal-price-value">${this.formatPrice(signal.stop)}</div>
          </div>
        </div>

        <div class="signal-actions">
          <button class="signal-btn signal-btn-primary" onclick="event.stopPropagation(); window.openQuickBacktest('${signal.symbol}', '${signal.strategy}')">å¿«é€Ÿå›æµ‹</button>
          <button class="signal-btn signal-btn-secondary" onclick="event.stopPropagation(); window.followSignal('${signal.symbol}', '${signal.side}')">ä¸€é”®æ¨¡æ‹Ÿ</button>
        </div>
      </div>
    `).join('');

    // æ·»åŠ å¤é€‰æ¡†å˜åŒ–ç›‘å¬å™¨
    setTimeout(() => {
      this.setupCompareCheckboxListeners();
    }, 100);
  }

  private setupCompareCheckboxListeners() {}

  private getStrategyName(strategy: string): string {
    const names: Record<string, string> = {
      'vegas_tunnel': 'Vegasé€šé“',
      'chan_simplified': 'ç®€åŒ–ç¼ è®º',
      'macd': 'MACD'
    };
    return names[strategy] || strategy;
  }

  private formatPrice(price: number): string {
    if (price >= 1000) return price.toFixed(0);
    if (price >= 1) return price.toFixed(2);
    if (price >= 0.001) return price.toFixed(4);
    return price.toFixed(6);
  }

  private updateCurrentView() {
    if (this.currentTab === 'home') {
      // åœ¨å¸‚åœºé¡µé¢ï¼Œæ›´æ–°æ‰€æœ‰åŒºå—
      this.updateQuotes();
      this.updateSignals();
      this.updateRecommendations();
      this.updateReviews();
      this.updateRankings();
    }
    if (this.currentTab === 'backtest') this.updateSignals();
  }

  private startUpdates() {
    // ç§»åŠ¨ç«¯ä¸éœ€è¦æ—¶é—´æ˜¾ç¤ºï¼Œå·²ç»æ”¹ä¸ºå­¦ä¹ æˆç»©

    setInterval(() => {
      this.updateCurrentView();
      this.updateLearningStats();
    }, 30000);

    // æ£€æŸ¥APIè¿æ¥çŠ¶æ€
    this.checkApiStatus();

    // åˆå§‹åŒ–æ—¶æ›´æ–°å¸‚åœºé¡µé¢çš„æ‰€æœ‰æ•°æ®
    this.updateQuotes();
    this.updateSignals();
    this.updateRecommendations();
    this.updateReviews();
    this.updateRankings();
    this.updateLearningStats();
  }

  private async checkApiStatus() {
    const statusDot = document.querySelector('.status-dot');
    const statusText = document.querySelector('.status-text');

    try {
      const response = await fetch(`${BASE_API}/`, {
        method: 'GET'
      });

      if (response.ok) {
        const result = await response.json();
        if (result.status === 'running') {
          // APIåœ¨çº¿
          statusDot?.classList.remove('offline');
          statusDot?.classList.add('online');
          if (statusText) statusText.textContent = 'çœŸå®æ•°æ®';
          console.log('âœ… APIæœåŠ¡å™¨è¿æ¥æˆåŠŸï¼Œä½¿ç”¨çœŸå®ç­–ç•¥æ•°æ®');
        } else {
          throw new Error('APIçŠ¶æ€å¼‚å¸¸');
        }
      } else {
        throw new Error('APIå“åº”é”™è¯¯');
      }
    } catch (error) {
      // APIç¦»çº¿ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      statusDot?.classList.remove('online');
      statusDot?.classList.add('offline');
      if (statusText) statusText.textContent = 'æ¨¡æ‹Ÿæ•°æ®';
      console.warn('âš ï¸ APIæœåŠ¡å™¨æœªè¿æ¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®', error);
    }
  }

  private async updateLearningStats() {
    const profitRatio = document.getElementById('profit-ratio');
    const winRate = document.getElementById('win-rate');
    const maxDrawdownStat = document.getElementById('max-drawdown-stat');
    // åŒæ­¥â€œæˆ‘çš„â€é¡µæ¦‚è§ˆ
    const pfWin = document.getElementById('pf-win');
    const pfDd = document.getElementById('pf-dd');
    const pfRet = document.getElementById('pf-ret');

    try {
      // è°ƒç”¨çœŸå®APIè·å–å­¦ä¹ æˆç»©æ•°æ®
      const response = await fetch(`${BASE_API}/api/learning-stats`);
      if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');

      const result = await response.json();
      if (!result.success) throw new Error(result.error || 'æ•°æ®è·å–å¤±è´¥');

      const stats = result.data;

      if (profitRatio) profitRatio.textContent = stats.profitRatio;
      if (winRate) winRate.textContent = stats.winRate;
      if (maxDrawdownStat) maxDrawdownStat.textContent = stats.maxDrawdown;
      if (pfRet) pfRet.textContent = `${stats.profitRatio}%`;
      if (pfWin) pfWin.textContent = stats.winRate;
      if (pfDd) pfDd.textContent = stats.maxDrawdown;

    } catch (error) {
      console.error('è·å–å­¦ä¹ æˆç»©å¤±è´¥:', error);
      // é™çº§åˆ°æœ¬åœ°é€»è¾‘
      this.updateLearningStatsFallback();
    }
  }

  private updateLearningStatsFallback() {
    const profitRatio = document.getElementById('profit-ratio');
    const winRate = document.getElementById('win-rate');
    const maxDrawdownStat = document.getElementById('max-drawdown-stat');

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ç”¨äº†ç­–ç•¥
    const hasActiveStrategies = this.activeStrategies.size > 0 && this.hasUserConfigured();

    if (hasActiveStrategies) {
      // ç”Ÿæˆæ¨¡æ‹Ÿå­¦ä¹ æˆç»©
      const mockProfitRatio = (1.2 + Math.random() * 1.0).toFixed(1); // 1.2-2.2
      const mockWinRate = Math.floor(Math.random() * 25) + 55; // 55-80%
      const mockMaxDrawdown = Math.floor(Math.random() * 8) + 3; // 3-10%

      if (profitRatio) profitRatio.textContent = mockProfitRatio;
      if (winRate) winRate.textContent = `${mockWinRate}%`;
      if (maxDrawdownStat) maxDrawdownStat.textContent = `${mockMaxDrawdown}%`;
    } else {
      // æ˜¾ç¤ºé»˜è®¤å€¼
      if (profitRatio) profitRatio.textContent = '--/--';
      if (winRate) winRate.textContent = '--/--';
      if (maxDrawdownStat) maxDrawdownStat.textContent = '--/--';
    }
  }

  public refreshData() {
    const fabBtn = document.querySelector('.fab-refresh');
    if (fabBtn) {
      fabBtn.classList.add('spinning');
      setTimeout(() => fabBtn.classList.remove('spinning'), 1000);
    }

    this.updateCurrentView();
  }

  public runBacktest() {
    // æ˜¾ç¤ºå›æµ‹è¿›åº¦
    const backtestPanel = document.querySelector('.backtest-panel');
    if (backtestPanel) {
      const button = backtestPanel.querySelector('.btn-primary') as HTMLElement;
      if (button) {
        button.textContent = 'æ­£åœ¨å›æµ‹...';
        button.style.background = 'var(--text-muted)';
      }
    }

    // åœ¨å›æµ‹é¡µé¢æ˜¾ç¤ºç»“æœï¼Œä¸è·³è½¬
    setTimeout(() => {
      this.showBacktestResults();
    }, 2000); // å¢åŠ åˆ°2ç§’ï¼Œè®©ç”¨æˆ·æ„Ÿè§‰åœ¨è®¡ç®—
  }

  private showBacktestResults() {
    const backtestPanel = document.querySelector('.backtest-panel');
    if (!backtestPanel) return;

    // æ¢å¤æŒ‰é’®çŠ¶æ€
    const button = backtestPanel.querySelector('.btn-primary') as HTMLElement;
    if (button) {
      button.textContent = 'è¿è¡Œå›æµ‹';
      button.style.background = '';
    }

    // åœ¨å›æµ‹é¢æ¿ä¸‹æ–¹æ˜¾ç¤ºç»“æœ
    let resultsContainer = document.getElementById('backtest-results');
    if (!resultsContainer) {
      resultsContainer = document.createElement('div');
      resultsContainer.id = 'backtest-results';
      resultsContainer.style.marginTop = 'var(--space-lg)';
      backtestPanel.parentNode?.insertBefore(resultsContainer, backtestPanel.nextSibling);
    }

    const lookaheadValue = (document.getElementById('lookahead-slider') as HTMLInputElement)?.value || '12';

    resultsContainer.innerHTML = `
      <div style="background: var(--bg-surface); border-radius: var(--radius-card); padding: var(--space-lg); border: 1px solid var(--border-base); box-shadow: var(--shadow-1);">
        <h3 style="color: var(--brand-primary); margin-bottom: var(--space-md); font-size: 18pt; text-align: center;">ğŸ§ª å›æµ‹ç»“æœ</h3>

        <div style="background: var(--brand-bg); padding: var(--space-md); border-radius: var(--radius-chip); margin-bottom: var(--space-md); border: 1px solid rgba(0, 213, 255, 0.3);">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-sm); text-align: center;">
            <div>
              <div style="color: var(--text-muted); font-size: 12pt;">å‘¨æœŸ</div>
              <div style="color: var(--text-primary); font-weight: 600;">${this.currentTimeframe}</div>
            </div>
            <div>
              <div style="color: var(--text-muted); font-size: 12pt;">Kçº¿æ•°</div>
              <div style="color: var(--text-primary); font-weight: 600;">${lookaheadValue}</div>
            </div>
            <div>
              <div style="color: var(--text-muted); font-size: 12pt;">ç­–ç•¥</div>
              <div style="color: var(--text-primary); font-weight: 600;">${this.activeStrategies.size}</div>
            </div>
          </div>
        </div>

        <div style="display: grid; gap: var(--space-md);">
          ${Object.keys(this.basePrices).slice(0, 4).map(symbol => {
            const winRate = Math.floor(Math.random() * 40) + 45; // 45-85%
            const trades = Math.floor(Math.random() * 25) + 15; // 15-40æ¬¡
            const avgR = (Math.random() * 1.5 + 0.5).toFixed(2); // 0.5-2.0
            const maxDD = Math.floor(Math.random() * 12) + 3; // 3-15%

            return `
              <div style="background: var(--bg-surface-2); padding: var(--space-md); border-radius: var(--radius-chip); border: 1px solid var(--border-base);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                  <div style="font-size: 16pt; font-weight: 600; color: var(--text-primary);">${symbol.replace('/USDT', '')}</div>
                  <div style="color: ${winRate >= 60 ? 'var(--bull-green)' : winRate >= 50 ? 'var(--warn-amber)' : 'var(--bear-red)'}; font-weight: 600;">${winRate}%</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-sm); font-size: 14pt;">
                  <div style="text-align: center;">
                    <div style="color: var(--text-muted);">äº¤æ˜“æ¬¡æ•°</div>
                    <div style="color: var(--text-primary); font-weight: 500;">${trades}</div>
                  </div>
                  <div style="text-align: center;">
                    <div style="color: var(--text-muted);">å¹³å‡R</div>
                    <div style="color: var(--brand-primary); font-weight: 500;">${avgR}</div>
                  </div>
                  <div style="text-align: center;">
                    <div style="color: var(--text-muted);">æœ€å¤§å›æ’¤</div>
                    <div style="color: var(--bear-red); font-weight: 500;">${maxDD}%</div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        <div style="margin-top: var(--space-lg); text-align: center;">
          <button onclick="document.getElementById('backtest-results').remove()" style="padding: var(--space-sm) var(--space-lg); background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); border: none; border-radius: var(--radius-chip); cursor: pointer; font-size: 14pt;">
            å…³é—­ç»“æœ
          </button>
        </div>
      </div>
    `;
  }

  public getUserParams(): UserParams {
    // è¿”å›å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ç”¨æˆ·å‚æ•°ï¼Œè€Œä¸æ˜¯ä»DOMè¯»å–
    return { ...this.userParams };
  }

  // ä»DOMè¯»å–å½“å‰è®¾ç½®é¡µé¢çš„å€¼
  private readParamsFromDOM(): UserParams {
    const profitTarget = Number((document.getElementById('profit-target') as HTMLInputElement)?.value || 5);
    const maxDrawdown = Number((document.getElementById('max-drawdown') as HTMLInputElement)?.value || 15);
    const riskExposure = Number((document.getElementById('risk-exposure') as HTMLInputElement)?.value || 5);
    const capitalSize = Number((document.getElementById('capital-size') as HTMLInputElement)?.value || 10000);
    const monitoringFreq = (document.getElementById('monitoring-frequency') as HTMLSelectElement)?.value || 'daily';

    return { profitTarget, maxDrawdown, riskExposure, capitalSize, monitoringFreq };
  }

  // ä¿å­˜ç”¨æˆ·å‚æ•°åˆ°å†…å­˜
  public saveUserParams(): void {
    // ä¼˜å…ˆè¯»å–â€œæˆ‘çš„â€é¡µå‚æ•°æ§ä»¶ï¼ˆp-*ï¼‰ï¼Œä¸å­˜åœ¨æ—¶å›é€€åˆ°æ—§æ§ä»¶
    const profit = (document.getElementById('p-profit') as HTMLInputElement)?.value;
    const dd = (document.getElementById('p-dd') as HTMLInputElement)?.value;
    const risk = (document.getElementById('p-risk') as HTMLInputElement)?.value;
    const capital = (document.getElementById('p-capital') as HTMLInputElement)?.value;
    const monitor = (document.getElementById('p-monitor') as HTMLSelectElement)?.value;
    if (profit !== undefined || dd !== undefined || risk !== undefined || capital !== undefined || monitor !== undefined) {
      this.userParams = {
        profitTarget: Number(profit ?? this.userParams.profitTarget),
        maxDrawdown: Number(dd ?? this.userParams.maxDrawdown),
        riskExposure: Number(risk ?? this.userParams.riskExposure),
        capitalSize: Number(capital ?? this.userParams.capitalSize),
        monitoringFreq: String(monitor ?? this.userParams.monitoringFreq)
      };
    } else {
      this.userParams = this.readParamsFromDOM();
    }
    this.hasConfiguredFlag = true; // æ ‡è®°ç”¨æˆ·å·²ç»ä¿å­˜è¿‡é…ç½®
    console.log('ä¿å­˜ç”¨æˆ·å‚æ•°:', this.userParams);
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»é…ç½®è¿‡å‚æ•°
  private hasUserConfigured(): boolean {
    return this.hasConfiguredFlag;
  }

  // å°†å†…å­˜ä¸­çš„å‚æ•°åŒæ­¥åˆ°DOMè¾“å…¥æ¡†
  private syncParamsToDOM(): void {
    const profitSlider = document.getElementById('profit-target') as HTMLInputElement;
    const profitValue = document.getElementById('profit-target-value');
    const drawdownSlider = document.getElementById('max-drawdown') as HTMLInputElement;
    const drawdownValue = document.getElementById('max-drawdown-value');
    const riskSlider = document.getElementById('risk-exposure') as HTMLInputElement;
    const riskValue = document.getElementById('risk-exposure-value');
    const capitalInput = document.getElementById('capital-size') as HTMLInputElement;
    const monitoringSelect = document.getElementById('monitoring-frequency') as HTMLSelectElement;

    if (profitSlider && profitValue) {
      profitSlider.value = this.userParams.profitTarget.toString();
      profitValue.textContent = `${this.userParams.profitTarget}%`;
    }
    if (drawdownSlider && drawdownValue) {
      drawdownSlider.value = this.userParams.maxDrawdown.toString();
      drawdownValue.textContent = `${this.userParams.maxDrawdown}%`;
    }
    if (riskSlider && riskValue) {
      riskSlider.value = this.userParams.riskExposure.toString();
      riskValue.textContent = `${this.userParams.riskExposure}%`;
    }
    if (capitalInput) {
      capitalInput.value = this.userParams.capitalSize.toString();
    }
    if (monitoringSelect) {
      monitoringSelect.value = this.userParams.monitoringFreq;
    }
  }

  private calculateRecommendation(params: UserParams) {
    const { profitTarget, maxDrawdown, riskExposure, monitoringFreq } = params;

    // 1. æ”¶ç›Šç›®æ ‡ â†’ ç­–ç•¥è¿›æ”»æ€§
    let strategyType = '';
    let strategies = [];
    if (profitTarget < 5) {
      strategyType = 'é•¿å‘¨æœŸç¨³å¥å‹';
      strategies = ['EMAäº¤å‰', 'å¸ƒæ—å¸¦å›å½’'];
    } else if (profitTarget <= 15) {
      strategyType = 'æ··åˆå¹³è¡¡å‹';
      strategies = ['Vegasé€šé“', 'RSIèƒŒç¦»'];
    } else {
      strategyType = 'é«˜æ³¢åŠ¨è¿›æ”»å‹';
      strategies = ['ATRçªç ´', 'åŠ¨é‡ç­–ç•¥'];
    }

    // 2. æœ€å¤§å›æ’¤ â†’ ç­–ç•¥è¿‡æ»¤
    if (maxDrawdown <= 10) {
      strategies = strategies.filter(s => !['ATRçªç ´', 'åŠ¨é‡ç­–ç•¥'].includes(s));
      if (strategies.length === 0) strategies = ['EMAäº¤å‰'];
    }

    // 3. ç›¯ç›˜é¢‘ç‡ â†’ æ—¶é—´å‘¨æœŸ
    let timeframe = '';
    if (monitoringFreq === 'realtime') timeframe = '4H';
    else if (monitoringFreq === 'daily') timeframe = '1D';
    else timeframe = '1W';

    // 4. é£é™©æš´éœ²åº¦ â†’ å¸ç§æ•°é‡
    let coinCount = Math.min(Math.floor(20 / riskExposure), 10);
    coinCount = Math.max(coinCount, 1);

    // 5. æ¨¡æ‹Ÿå›æµ‹æ•°æ®ï¼ˆæ ¹æ®å‚æ•°ç”Ÿæˆåˆç†æ•°æ®ï¼‰
    const winRate = Math.max(45, Math.min(75, 65 - (profitTarget - 5) * 2));
    const profitLossRatio = Math.max(1.2, Math.min(2.5, 1.8 + (maxDrawdown - 15) * 0.02));
    const maxDD = Math.min(maxDrawdown * 0.9, maxDrawdown - 2);
    const annualizedReturn = profitTarget * 12 * 0.8; // 80%è¾¾æˆç‡

    return {
      strategyType,
      strategies: strategies.slice(0, 2),
      timeframe,
      coinCount,
      backtest: {
        winRate: Math.round(winRate),
        profitLossRatio: Number(profitLossRatio.toFixed(1)),
        maxDrawdown: Math.round(maxDD),
        annualizedReturn: Math.round(annualizedReturn)
      },
      reason: this.generateReason(params, strategyType, timeframe)
    };
  }

  private generateReason(params: UserParams, strategyType: string, timeframe: string) {
    const { profitTarget, maxDrawdown, monitoringFreq } = params;
    const freqMap: Record<string, string> = {
      'realtime': 'éšæ—¶ç›‘æ§',
      'daily': 'æ¯æ—¥1æ¬¡',
      'weekly': 'æ¯å‘¨1æ¬¡'
    };
    const freqText = freqMap[monitoringFreq] || 'æ¯æ—¥1æ¬¡';

    return `å› ä¸ºä½ è®¾å®šäº†æœˆåŒ–${profitTarget}%æ”¶ç›Šç›®æ ‡ï¼Œä¸”æœ€å¤§å›æ’¤å®¹å¿åº¦ä¸ºâ‰¤${maxDrawdown}%ï¼Œç›¯ç›˜é¢‘ç‡ä¸º${freqText} â†’ ç³»ç»Ÿä¸ºä½ åŒ¹é…äº†${timeframe}${strategyType}ï¼Œåœ¨è¿‡å»90å¤©è¡¨ç°ä¼˜å¼‚ã€‚`;
  }

  public updateRecommendations() {
    const container = document.getElementById('recommendation-cards');
    const hintContainer = document.getElementById('recommendation-config-hint');
    if (!container) return;

    const params = this.getUserParams();

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»é…ç½®äº†å‚æ•°ï¼ˆæœ‰ä¸€ä¸ªæ ‡å¿—ä½è¡¨ç¤ºå·²ä¿å­˜è¿‡é…ç½®ï¼‰
    const hasConfigured = this.hasUserConfigured();

    if (!hasConfigured && hintContainer) {
      // æ˜¾ç¤ºé…ç½®æç¤ºï¼Œéšè—æ¨èç»“æœ
      hintContainer.style.display = 'block';
      container.innerHTML = '';
      return;
    }

    // éšè—é…ç½®æç¤ºï¼Œæ˜¾ç¤ºæ¨èç»“æœ
    if (hintContainer) {
      hintContainer.style.display = 'none';
    }

    const recommendation = this.calculateRecommendation(params);

    container.innerHTML = `
      <div class="recommendation-card">
        <div class="recommendation-title">æ¨èç­–ç•¥ç»„åˆ</div>
        <div class="recommendation-meta">
          <div class="meta-row">
            <span class="meta-label">å‘¨æœŸ:</span>
            <span class="meta-value">${recommendation.timeframe}</span>
          </div>
          <div class="meta-row">
            <span class="meta-label">ç­–ç•¥:</span>
            <span class="meta-value">${recommendation.strategies.join(' + ')}</span>
          </div>
          <div class="meta-row">
            <span class="meta-label">å¸ç§èŒƒå›´:</span>
            <span class="meta-value">Top ${recommendation.coinCount}</span>
          </div>
        </div>
        <div class="backtest-results">
          <div class="backtest-title">å›æµ‹ç»“æœ</div>
          <div class="backtest-grid">
            <div class="backtest-item">
              <div class="backtest-label">èƒœç‡</div>
              <div class="backtest-value">${recommendation.backtest.winRate}%</div>
            </div>
            <div class="backtest-item">
              <div class="backtest-label">ç›ˆäºæ¯”</div>
              <div class="backtest-value">${recommendation.backtest.profitLossRatio}</div>
            </div>
            <div class="backtest-item">
              <div class="backtest-label">æœ€å¤§å›æ’¤</div>
              <div class="backtest-value">${recommendation.backtest.maxDrawdown}%</div>
            </div>
            <div class="backtest-item">
              <div class="backtest-label">å¹´åŒ–æ”¶ç›Š</div>
              <div class="backtest-value">${recommendation.backtest.annualizedReturn}%</div>
            </div>
          </div>
        </div>
        <div class="recommendation-reason">
          <div class="reason-title">ğŸ“Œ æ¨èé€»è¾‘</div>
          <div class="reason-content">${recommendation.reason}</div>
        </div>
        <div class="recommendation-actions">
          <button class="signal-btn signal-btn-primary" onclick="window.enableRecommendation('ç­–ç•¥ç»„åˆ')">å¯ç”¨ç­–ç•¥</button>
          <button class="signal-btn signal-btn-secondary" onclick="window.viewBacktest()">æŸ¥çœ‹è¯¦ç»†å›æµ‹</button>
        </div>
      </div>
    `;
  }

  private updateReviews() {
    const container = document.getElementById('review-content');
    if (!container) return;

    const reviews = [
      { symbol: 'BTC', result: 'profit', value: '+2.3%' },
      { symbol: 'ETH', result: 'profit', value: '+1.8%' },
      { symbol: 'SOL', result: 'loss', value: '-0.9%' },
      { symbol: 'XRP', result: 'profit', value: '+3.1%' }
    ];

    container.innerHTML = reviews.map(review => `
      <div class="review-item">
        <div class="review-symbol">${review.symbol}</div>
        <div class="review-result ${review.result}">${review.value}</div>
      </div>
    `).join('');
  }

  private updateRankings() {
    const container = document.getElementById('ranking-content');
    if (!container) return;

    fetch(`${BASE_API}/api/config`).then(r => r.json()).then(cfg => {
      const data = cfg?.data || {};
      const names: Record<string, string> = data.strategy_names || {};
      const keys = Object.keys(names);
      if (!keys.length) {
        container.innerHTML = '';
        return;
      }

      // ç”Ÿæˆå ä½èƒœç‡ï¼ˆä»…å±•ç¤ºç”¨é€”ï¼‰
      const rows = keys.map((k) => {
        const label = names[k] || k;
        const rate = `${Math.floor(55 + Math.random() * 25)}%`;
        return { strategy: label, rate };
      });

      container.innerHTML = rows.map(row => `
        <div class="ranking-item">
          <div class="ranking-strategy">${row.strategy}</div>
          <div class="ranking-rate">${row.rate}</div>
        </div>
      `).join('');
    }).catch(() => {
      container.innerHTML = '';
    });
  }


}

// æ¡Œé¢ç«¯ç•Œé¢ç±»ï¼ˆåŸæœ‰çš„ç±»ï¼Œç®€åŒ–ç‰ˆï¼‰
interface Quote {
  symbol: string;
  close: number;
  high: number;
  low: number;
  time: string;
}

interface Signal {
  symbol: string;
  strategy: string;
  side: 'BUY' | 'SELL';
  entry: number;
  target: number;
  stop: number;
  confidence: number;
  tf: string;
  reason: string;
  ts: Date;
}

class TradingDashboard {
  private currentTimeframe = '4h';
  private activeStrategies: Set<string> = new Set(['vegas_tunnel', 'chan_simplified', 'macd']);
  private strategyNamesMap: Record<string, string> = {};

  // åŸºç¡€ä»·æ ¼æ•°æ®
  private basePrices: Record<string, number> = {
    'BTC/USDT': 65000,
    'ETH/USDT': 3200,
    'BNB/USDT': 590,
    'SOL/USDT': 140,
    'XRP/USDT': 0.52,
    'ADA/USDT': 0.45,
    'DOGE/USDT': 0.12,
    'TRX/USDT': 0.08,
    'AVAX/USDT': 28,
    'DOT/USDT': 6.5,
    'SHIB/USDT': 0.000024,
    'LINK/USDT': 12.5,
    'TON/USDT': 5.8,
    'LTC/USDT': 85,
    'MATIC/USDT': 0.85
  };

  private strategies = ['vegas_tunnel', 'chan_simplified', 'macd', 'sma_cross', 'rsi_reversal'];
  private symbols = Object.keys(this.basePrices);

  constructor() {
    this.init();
  }

  private init() {
    // åŠ¨æ€åŠ è½½ç­–ç•¥åˆ—è¡¨å¹¶æ¸²æŸ“å¤é€‰æ¡†
    this.initStrategiesFromConfig();

    this.setupEventListeners();
    this.updateLearningStatsDesktop();
    this.generateInitialData();

    // æ¯30ç§’æ›´æ–°å­¦ä¹ æˆç»©
    setInterval(() => this.updateLearningStatsDesktop(), 30000);

    // æ¯30ç§’éšæœºæ›´æ–°æ•°æ®
    setInterval(() => this.updateRandomData(), 30000);
  }

  private setupEventListeners() {
    // æ—¶é—´å‘¨æœŸæŒ‰é’®
    for (const btn of document.querySelectorAll('.timeframe-btn')) {
      btn.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const tf = target.getAttribute('data-tf');
        if (tf) {
          this.setTimeframe(tf);
        }
      });
    }

    // åŠ¨æ€ç­–ç•¥å¤é€‰æ¡†äº‹ä»¶ï¼ˆäº‹ä»¶å§”æ‰˜ï¼Œé¿å…é‡å¤ç»‘å®šï¼‰
    const cbContainer = document.querySelector('.checkbox-group');
    if (cbContainer && !cbContainer.getAttribute('data-wired')) {
      cbContainer.setAttribute('data-wired', '1');
      cbContainer.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        if (target && target.classList.contains('strategy-cb')) {
          const key = target.value;
          if (target.checked) this.activeStrategies.add(key);
          else this.activeStrategies.delete(key);
          this.generateSignals();
        }
      });
    }
  }

  private async initStrategiesFromConfig() {
    try {
      const resp = await fetch(`${BASE_API}/api/config`);
      if (!resp.ok) return;
      const payload = await resp.json();
      const data = payload?.data || {};
      const enabled: string[] = data.strategies || [];
      const namesMap: Record<string, string> = data.strategy_names || {};

      const allKeys = Object.keys(namesMap);
      if (allKeys.length) {
        this.strategyNamesMap = namesMap;
        this.strategies = allKeys;
        this.activeStrategies = new Set(enabled.length ? enabled : allKeys.slice(0, Math.min(6, allKeys.length)));
        this.renderStrategyCheckboxes(allKeys);
      }
    } catch (_) {
      // å¿½ç•¥é”™è¯¯ï¼Œä¿æŒé»˜è®¤ç­–ç•¥
    }
  }

  private renderStrategyCheckboxes(keys: string[]) {
    const container = document.querySelector('.checkbox-group');
    if (!container) return;
    const html = keys.map((key) => {
      const label = this.strategyNamesMap[key] || key;
      const checked = this.activeStrategies.has(key) ? 'checked' : '';
      const safeId = `cb-${key.replace(/[^a-zA-Z0-9_-]/g, '')}`;
      return `
        <div class="checkbox-item">
          <input type="checkbox" class="strategy-cb" id="${safeId}" value="${key}" ${checked}>
          <label for="${safeId}">${label} <span style="opacity:.6;font-size:12px;">(${key})</span></label>
        </div>`;
    }).join('');
    (container as HTMLElement).innerHTML = html;
  }

  private async updateLearningStatsDesktop() {
    const profitRatio = document.getElementById('profit-ratio-desktop');
    const winRate = document.getElementById('win-rate-desktop');
    const maxDrawdownStat = document.getElementById('max-drawdown-desktop');

    try {
      // è°ƒç”¨çœŸå®APIè·å–å­¦ä¹ æˆç»©æ•°æ®
      const response = await fetch(`${BASE_API}/api/learning-stats`);
      if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');

      const result = await response.json();
      if (!result.success) throw new Error(result.error || 'æ•°æ®è·å–å¤±è´¥');

      const stats = result.data;

      if (profitRatio) profitRatio.textContent = stats.profitRatio;
      if (winRate) winRate.textContent = stats.winRate;
      if (maxDrawdownStat) maxDrawdownStat.textContent = stats.maxDrawdown;

    } catch (error) {
      console.error('è·å–å­¦ä¹ æˆç»©å¤±è´¥:', error);
      // é™çº§åˆ°æœ¬åœ°é€»è¾‘
      this.updateLearningStatsDesktopFallback();
    }
  }

  private updateLearningStatsDesktopFallback() {
    const profitRatio = document.getElementById('profit-ratio-desktop');
    const winRate = document.getElementById('win-rate-desktop');
    const maxDrawdownStat = document.getElementById('max-drawdown-desktop');

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ç”¨äº†ç­–ç•¥
    const hasActiveStrategies = this.activeStrategies.size > 0;

    if (hasActiveStrategies) {
      // ç”Ÿæˆæ¨¡æ‹Ÿå­¦ä¹ æˆç»©
      const mockProfitRatio = (1.2 + Math.random() * 1.0).toFixed(1); // 1.2-2.2
      const mockWinRate = Math.floor(Math.random() * 25) + 55; // 55-80%
      const mockMaxDrawdown = Math.floor(Math.random() * 8) + 3; // 3-10%

      if (profitRatio) profitRatio.textContent = mockProfitRatio;
      if (winRate) winRate.textContent = `${mockWinRate}%`;
      if (maxDrawdownStat) maxDrawdownStat.textContent = `${mockMaxDrawdown}%`;
    } else {
      // æ˜¾ç¤ºé»˜è®¤å€¼
      if (profitRatio) profitRatio.textContent = '--/--';
      if (winRate) winRate.textContent = '--/--';
      if (maxDrawdownStat) maxDrawdownStat.textContent = '--/--';
    }
  }

  private setTimeframe(tf: string) {
    this.currentTimeframe = tf;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    for (const btn of document.querySelectorAll('.timeframe-btn')) {
      btn.classList.remove('active');
    }
    document.querySelector(`[data-tf="${tf}"]`)?.classList.add('active');

    // æ›´æ–°æ˜¾ç¤º
    const exchangeTfEl = document.getElementById('exchange-tf');
    if (exchangeTfEl) {
      exchangeTfEl.textContent = `binance / ${tf}`;
    }

    this.generateSignals();
  }

  private generateMockQuotes(): Quote[] {
    return this.symbols.slice(0, 8).map(symbol => {
      const basePrice = this.basePrices[symbol];
      const variation = (Math.random() - 0.5) * 0.06; // Â±3% å˜åŒ–
      const close = basePrice * (1 + variation);
      const spread = Math.abs(variation) * 0.5;
      const high = close * (1 + spread);
      const low = close * (1 - spread);

      return {
        symbol,
        close,
        high,
        low,
        time: new Date().toLocaleTimeString('zh-CN', { hour12: false })
      };
    });
  }

  private formatPrice(price: number): string {
    if (price >= 1000) return price.toFixed(2);
    if (price >= 1) return price.toFixed(4);
    if (price >= 0.001) return price.toFixed(6);
    return price.toFixed(8);
  }

  private generateMockSignals(): Signal[] {
    const signals: Signal[] = [];
    const signalCount = Math.floor(Math.random() * 4) + 2; // 2-5ä¸ªä¿¡å·

    for (let i = 0; i < signalCount; i++) {
      const symbol = this.symbols[Math.floor(Math.random() * this.symbols.length)];
      const strategiesArray = Array.from(this.activeStrategies);
      const strategy = strategiesArray[Math.floor(Math.random() * strategiesArray.length)];
      const side: 'BUY' | 'SELL' = Math.random() > 0.5 ? 'BUY' : 'SELL';

      const basePrice = this.basePrices[symbol];
      const entry = basePrice * (1 + (Math.random() - 0.5) * 0.04);

      let target: number;
      let stop: number;
      if (side === 'BUY') {
        target = entry * (1 + 0.02 + Math.random() * 0.02); // 2-4% æ­¢ç›ˆ
        stop = entry * (1 - 0.015 - Math.random() * 0.01); // 1.5-2.5% æ­¢æŸ
      } else {
        target = entry * (1 - 0.02 - Math.random() * 0.02); // 2-4% æ­¢ç›ˆ
        stop = entry * (1 + 0.015 + Math.random() * 0.01); // 1.5-2.5% æ­¢æŸ
      }

      signals.push({
        symbol,
        strategy,
        side,
        entry,
        target,
        stop,
        confidence: Math.floor(Math.random() * 20) + 30, // 30-50
        tf: this.currentTimeframe,
        reason: `å»ºè®®å•ï¼š${symbol}ï¼ˆ${this.currentTimeframe}ï¼‰${side === 'BUY' ? 'åšå¤š' : 'åšç©º'}ï¼›${strategy} ç­–ç•¥è§¦å‘`,
        ts: new Date()
      });
    }

    return signals;
  }

  private renderQuotes(quotes: Quote[]) {
    const tbody = document.getElementById('quotes-tbody');
    if (!tbody) return;

    tbody.innerHTML = quotes.map(quote => `
      <tr>
        <td><strong>${quote.symbol}</strong></td>
        <td>${this.formatPrice(quote.close)}</td>
        <td>${this.formatPrice(quote.high)}</td>
        <td>${this.formatPrice(quote.low)}</td>
        <td>${quote.time}</td>
      </tr>
    `).join('');
  }

  private renderSignals(signals: Signal[]) {
    const container = document.getElementById('signals-container');
    const probeResult = document.getElementById('probe-result');

    if (!container || !probeResult) return;

    // æ¢é’ˆæ£€æŸ¥
    const pairs = new Set(signals.map(s => `${s.symbol} | ${s.strategy}`));
    probeResult.innerHTML = `
      <div style="background: #065f46; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #10b981;">
        <strong>Probe â†’</strong> æ”¶åˆ° ${signals.length} æ¡ï¼›å”¯ä¸€å¯¹æ•°ï¼š${pairs.size}
        <div style="font-family: monospace; font-size: 0.875rem; margin-top: 5px; color: #94a3b8;">
          ${Array.from(pairs).join('<br>')}
        </div>
      </div>
    `;

    if (signals.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8;">å½“æ ¹æ— è§¦å‘ã€‚</div>';
      return;
    }

    // æŒ‰symbolåˆ†ç»„
    const groupedSignals = signals.reduce((acc, signal) => {
      if (!acc[signal.symbol]) acc[signal.symbol] = [];
      acc[signal.symbol].push(signal);
      return acc;
    }, {} as Record<string, Signal[]>);

    container.innerHTML = Object.entries(groupedSignals)
      .map(([symbol, symbolSignals]) => `
        <div style="margin-bottom: 25px;">
          <h3 style="color: #f1f5f9; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 5px;">
            ${symbol}
          </h3>
          ${symbolSignals.map(signal => `
            <div class="signal-card ${signal.side.toLowerCase()}">
              <div class="signal-header">
                <div class="signal-title">
                  ${signal.side} ${signal.symbol}
                </div>
                <div class="signal-strategy">${signal.strategy}</div>
              </div>
              <div style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 10px;">
                ä¿¡å¿ƒ ${signal.confidence} ï½œ å‘¨æœŸï¼š${signal.tf} ï½œ æ—¶é—´ï¼š${signal.ts.toLocaleTimeString()}
              </div>
              <div class="signal-details">
                <div>å…¥åœºï¼š${this.formatPrice(signal.entry)}</div>
                <div>ç›®æ ‡ï¼š${this.formatPrice(signal.target)}</div>
                <div>æ­¢æŸï¼š${this.formatPrice(signal.stop)}</div>
                <div>ETAï¼šâ‰ˆ${this.getETA(signal.tf)}</div>
              </div>
              <div style="margin-top: 10px; font-size: 0.875rem; color: #d1d5db;">
                ${signal.reason}
              </div>
              <div class="signal-actions" style="margin-top:10px; display:flex; gap:8pt;">
                <button class="signal-btn signal-btn-secondary btn-sim" data-symbol="${signal.symbol}" data-side="${signal.side}" data-strategy="${signal.strategy}" data-tf="${signal.tf}" data-entry="${signal.entry}">åŠ å…¥â€œæˆ‘çš„â€</button>
              </div>
            </div>
          `).join('')}
        </div>
      `).join('');
  }

  private getETA(tf: string): string {
    const etaMap: Record<string, string> = {
      '4h': '4 å°æ—¶',
      '1d': '1 å¤©',
      '1w': '1 å‘¨'
    };
    return etaMap[tf] || 'æœªçŸ¥';
  }

  private async generateInitialData() {
    await this.fetchAndRenderDesktopQuotes();
    this.generateSignals();
  }

  private async generateSignals() {
    try {
      const response = await fetch(`${BASE_API}/api/signals`);
      if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
      const result = await response.json();
      if (!result.success) throw new Error(result.error || 'æ•°æ®è·å–å¤±è´¥');
      this.renderSignals(result.data as unknown as Signal[]);
    } catch (e) {
      // å¤±è´¥æ˜¾ç¤ºå ä½
      this.renderSignals([]);
    }
  }

  private async updateRandomData() {
    await this.fetchAndRenderDesktopQuotes();
    await this.generateSignals();
  }

  private async fetchAndRenderDesktopQuotes() {
    try {
      const resp = await fetch(`${BASE_API}/api/quotes`);
      if (!resp.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
      const data = await resp.json();
      if (!data.success) throw new Error(data.error || 'æ•°æ®è·å–å¤±è´¥');
      const mapped: Quote[] = (data.data || []).map((q: any) => ({
        symbol: q.symbol,
        close: q.close,
        high: q.close,
        low: q.close,
        time: new Date().toLocaleTimeString('zh-CN', { hour12: false })
      }));
      this.renderQuotes(mapped);
    } catch (e) {
      // æ˜¾ç¤ºç©ºçŠ¶æ€
      const tbody = document.getElementById('quotes-tbody');
      if (tbody) tbody.innerHTML = '';
    }
  }

  public refreshData() {
    // å®æ—¶åˆ·æ–°æ”¹ä¸ºè¯·æ±‚çœŸå®æ¥å£
    this.fetchAndRenderDesktopQuotes();
    this.generateSignals();

    // æ˜¾ç¤ºåˆ·æ–°åŠ¨ç”»
    const btn = document.querySelector('.refresh-btn') as HTMLElement;
    if (btn) {
      btn.style.transform = 'rotate(360deg)';
      btn.style.transition = 'transform 0.5s ease';
      setTimeout(() => {
        btn.style.transform = '';
        btn.style.transition = '';
      }, 500);
    }
  }

  public runBacktest() {
    const lookahead = (document.getElementById('lookahead') as HTMLInputElement)?.value || '12';

    // æ¨¡æ‹Ÿå›æµ‹ç»“æœ
    const results = this.symbols.slice(0, 5).map(symbol => {
      const trades = Math.floor(Math.random() * 15) + 5;
      const winRate = Math.floor(Math.random() * 40) + 30; // 30-70%
      const avgR = (Math.random() * 2 - 0.5).toFixed(3); // -0.5 to 1.5

      return {
        symbol,
        winRate,
        trades,
        avgR: Number.parseFloat(avgR)
      };
    });

    // æ˜¾ç¤ºå›æµ‹ç»“æœ
    const container = document.getElementById('signals-container');
    if (container) {
      container.innerHTML = `
        <div style="background: #1e293b; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #f1f5f9; margin-bottom: 15px;">ğŸ§ª å¿«å›æµ‹ç»“æœ</h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
            <div><strong>å‘¨æœŸï¼š</strong>${this.currentTimeframe}</div>
            <div><strong>å¯ç”¨ç­–ç•¥ï¼š</strong>${Array.from(this.activeStrategies).join(', ')}</div>
            <div><strong>Lookaheadï¼š</strong>${lookahead} æ ¹Kçº¿</div>
          </div>
          ${results.map(result => `
            <div style="background: #334155; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
              <div style="font-weight: 600; margin-bottom: 8px;">${result.symbol}</div>
              <div style="font-size: 0.875rem; color: #94a3b8;">
                èƒœç‡ï¼š${result.winRate}% ï½œ æ ·æœ¬ï¼š${result.trades} ï½œ å¹³å‡Rï¼š${result.avgR}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
  }
}

// å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
declare global {
  interface Window {
    refreshData: () => void;
    runBacktest: () => void;
    refreshMobileData: () => void;
    runMobileBacktest: () => void;
    openQuickBacktest: (symbol: string, strategy: string) => void;
    addToSimulation: (symbol: string, side: string) => void;
    followSignal: (symbol: string, side: string) => void;
    enableRecommendation: (title: string) => void;
    saveUserProfile: () => void;
    goToSettings: () => void;
    viewBacktest: () => void;
    compareSelectedSignals: () => void;
  }
}

// æ ¹æ®è®¾å¤‡ç±»å‹åˆå§‹åŒ–ä¸åŒçš„ç•Œé¢
if (isMobile()) {
  console.log('ğŸ“± å¯åŠ¨ç§»åŠ¨ç«¯ä¼˜åŒ–ç•Œé¢');
  const mobileDashboard = new MobileTradingDashboard();

  // å¯¼å‡ºç§»åŠ¨ç«¯å‡½æ•°
  window.refreshMobileData = () => mobileDashboard.refreshData();
  window.runMobileBacktest = () => mobileDashboard.runBacktest();
  window.openQuickBacktest = (symbol: string, strategy: string) => (mobileDashboard as any)['openQuickBacktest'](symbol, strategy);


  // æ–°å¢äº¤äº’åŠŸèƒ½
  window.addToSimulation = (symbol: string, side: string) => {
    alert(`å·²å°† ${side} ${symbol} æ·»åŠ åˆ°æ¨¡æ‹Ÿä»“ä½`);
  };

  window.followSignal = (symbol: string, side: string) => {
    alert(`å¼€å§‹æ¨¡æ‹Ÿ ${side} ${symbol}`);
  };

  window.enableRecommendation = (title: string) => {
    alert(`å·²å¯ç”¨æ¨èç­–ç•¥ï¼š${title}`);
  };

  window.saveUserProfile = () => {
    // å…ˆä¿å­˜å‚æ•°åˆ°å†…å­˜
    mobileDashboard.saveUserParams();

    // è·å–å·²ä¿å­˜çš„å‚æ•°
    const params = mobileDashboard.getUserParams();

    // æŒä¹…åŒ–åˆ°æœ¬åœ°ï¼Œä¾›â€œå¸‚åœº/å›æµ‹â€é»˜è®¤è¯»å–
    try {
      localStorage.setItem('user_profile_params', JSON.stringify(params));
    } catch (_) {}

    // ç«‹å³æ›´æ–°æ¨èå†…å®¹
    mobileDashboard.updateRecommendations();

    // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
    const message = `âœ… å·²ä¿å­˜ä¸ªæ€§åŒ–é…ç½®ï¼š\nğŸ“ˆ æ”¶ç›Šç›®æ ‡: ${params.profitTarget}%\nâš ï¸ æœ€å¤§å›æ’¤: ${params.maxDrawdown}%\nğŸ’° é£é™©æš´éœ²: ${params.riskExposure}%\nğŸ’µ æœ¬é‡‘è§„æ¨¡: ${params.capitalSize.toLocaleString()} USDT\n\nğŸ’¡ å³å°†è·³è½¬åˆ°å¸‚åœºé¡µé¢æŸ¥çœ‹æ¨èï¼`;
    alert(message);

    // 1ç§’åè‡ªåŠ¨åˆ‡æ¢åˆ°å¸‚åœºé¡µé¢æ˜¾ç¤ºæ¨èç»“æœ
    setTimeout(() => {
      mobileDashboard.switchTab('home');
    }, 1000);
  };

  window.goToSettings = () => {
    mobileDashboard.switchTab('profile');
    // å¯é€‰ï¼šæ»šåŠ¨åˆ°å‚æ•°å®šåˆ¶åŒºåŸŸ
    setTimeout(() => {
      const el = document.getElementById('profile-view');
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 50);
  };

  window.viewBacktest = () => {
    alert('ğŸ“Š æŸ¥çœ‹è¯¦ç»†å›æµ‹æ•°æ®\n\nè¿™é‡Œå¯ä»¥å±•ç¤ºæ›´è¯¦ç»†çš„å›æµ‹å›¾è¡¨ã€å†å²è¡¨ç°ç­‰ä¿¡æ¯');
  };

  window.compareSelectedSignals = () => {};

  console.log('ğŸš€ ç§»åŠ¨ç«¯é‡åŒ–äº¤æ˜“é¢æ¿å·²å¯åŠ¨ï¼');
  console.log('ğŸ“Š æ”¯æŒç­–ç•¥:', ['vegas_tunnel', 'chan_simplified', 'macd']);
  console.log('ğŸ“ˆ ç›‘æ§å¸ç§:', ['BTC', 'ETH', 'BNB', 'SOL', 'XRP', 'ADA', 'DOGE', 'TRX', 'AVAX', 'DOT', 'SHIB', 'LINK', 'TON', 'LTC', 'MATIC']);
} else {
  console.log('ğŸ’» å¯åŠ¨æ¡Œé¢ç«¯ç•Œé¢');
  const dashboard = new TradingDashboard();

  // å¯¼å‡ºæ¡Œé¢ç«¯å‡½æ•°
  window.refreshData = () => dashboard.refreshData();
  window.runBacktest = () => dashboard.runBacktest();

  console.log('ğŸš€ é‡åŒ–äº¤æ˜“é¢æ¿å·²å¯åŠ¨ï¼');
  console.log('ğŸ“Š æ”¯æŒç­–ç•¥:', ['vegas_tunnel', 'chan_simplified', 'macd', 'sma_cross', 'rsi_reversal']);
  console.log('ğŸ“ˆ ç›‘æ§å¸ç§:', ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT', 'XRP/USDT', 'ADA/USDT', 'DOGE/USDT', 'TRX/USDT', 'AVAX/USDT', 'DOT/USDT', 'SHIB/USDT', 'LINK/USDT', 'TON/USDT', 'LTC/USDT', 'MATIC/USDT']);
}

// ç»Ÿä¸€ DOMContentLoaded æ—¶åˆ·æ–°å¾½æ ‡
document.addEventListener('DOMContentLoaded', () => { try { updateBadge(); } catch(_) {} });

/* ================== SIM QUEUE + BADGE + FLY (STABLE) ================== */

/** æœ¬åœ°å­˜å‚¨é”® */
const SIM_QUEUE_KEY = 'simQueue';

/** è¯»å–/å†™å…¥é˜Ÿåˆ— */
function getSimQueue(): any[] {
  try { return JSON.parse(localStorage.getItem(SIM_QUEUE_KEY) || '[]'); }
  catch { return []; }
}
function setSimQueue(list: any[]) { localStorage.setItem(SIM_QUEUE_KEY, JSON.stringify(list)); }
function pushSimItem(item: any) { const l = getSimQueue(); l.push(item); setSimQueue(l); }

/** çº¢ç‚¹è®¡æ•°ï¼šå½“å‰ä»…ç»Ÿè®¡é˜Ÿåˆ—æ¡æ•°ï¼ˆå¦‚éœ€å¢åŠ â€œè¿è¡Œä¸­â€ï¼Œä½ å†ç›¸åŠ å³å¯ï¼‰ */
function updateBadge() {
  const badge = document.getElementById('mine-badge') as HTMLSpanElement | null;
  if (!badge) return;
  const n = getSimQueue().length;
  if (n > 0) { badge.textContent = String(n); badge.style.display = 'inline-flex'; }
  else { badge.style.display = 'none'; }
}

/** ç›®æ ‡å…ƒç´ ï¼ˆä¼˜å…ˆé£å‘å¾½æ ‡ï¼‰ */
function getMineTarget(): HTMLElement | null {
  const badge = document.getElementById('mine-badge') as HTMLElement | null;
  if (badge) {
    const visible = badge.offsetWidth > 0 && badge.offsetHeight > 0 && getComputedStyle(badge).display !== 'none';
    if (visible) return badge;
  }
  return (document.getElementById('nav-mine') as HTMLElement | null);
}

/** é£å…¥åŠ¨ç”»ï¼ˆviewport åæ ‡ + position:fixedï¼‰ */
function flyToMine(fromEl: HTMLElement) {
  const mine = getMineTarget();
  if (!mine) return;

  const s = fromEl.getBoundingClientRect();
  const startX = s.left + s.width / 2;
  const startY = s.top  + s.height/ 2;

  const dot = document.createElement('div');
  Object.assign(dot.style, {
    position: 'fixed',
    left: `${startX}px`,
    top:  `${startY}px`,
    width: '12px',
    height: '12px',
    borderRadius: '999px',
    background: '#0ea5e9',
    zIndex: '2147483647',
    pointerEvents: 'none',
  } as CSSStyleDeclaration);
  document.body.appendChild(dot);

  // ç­‰ä¸€å¸§ï¼Œç¡®ä¿ updateBadge æ˜¾ç¤ºå¾½æ ‡åå†å–ç»ˆç‚¹
  requestAnimationFrame(() => {
    const e = getMineTarget()?.getBoundingClientRect();
    if (!e) { dot.remove(); return; }
    const endX = e.left + e.width / 2;
    const endY = e.top  + e.height / 2;

    const dx = endX - startX;
    const dy = endY - startY;

    const anim = dot.animate(
      [
        { transform: 'translate(0,0) scale(1)',   opacity: 1 },
        { transform: `translate(${dx*0.55}px, ${dy*0.25}px) scale(1.1)`, opacity: 1, offset: 0.6 },
        { transform: `translate(${dx}px, ${dy}px) scale(0.3)`,           opacity: 0.15 },
      ],
      { duration: 650, easing: 'cubic-bezier(.2,.7,.2,1)' }
    );
    anim.onfinish = () => {
      dot.remove();
      const mineBtn = document.getElementById('nav-mine');
      if (mineBtn) { mineBtn.classList.add('pulse'); setTimeout(() => mineBtn.classList.remove('pulse'), 300); }
    };
  });
}

/** ç»Ÿä¸€ç‚¹å‡»å§”æ‰˜ï¼šæ•è·ä»»ä½• .btn-sim ï¼ˆæŒ‰é’®æ–‡æ¡ˆå¯å«â€œåŠ å…¥æˆ‘çš„â€ï¼‰ */
function handleSimClick(ev: Event) {
  const target = ev.target as HTMLElement | null;
  const btn = target?.closest?.('.btn-sim') as HTMLElement | null;
  if (!btn) return;

  const card = btn.closest('.signal-card') as HTMLElement | null;
  const ds = Object.assign({}, card?.dataset || {}, btn.dataset || {});
  const tf = ds.tf || document.querySelector('.timeframe-btn.active')?.getAttribute('data-tf') || '';

  const item = {
    id: (crypto as any)?.randomUUID?.() || String(Date.now()),
    symbol: ds.symbol || '',
    side: String(ds.side || '').toUpperCase(),   // BUY / SELL
    strategy: ds.strategy || '',
    tf,
    entry: ds.entry,
    createdAt: Date.now(),
    status: 'queued',
    disabled: false,
  };

  pushSimItem(item);     // å…¥é˜Ÿ
  updateBadge();         // çº¢ç‚¹ +1
  flyToMine(btn);        // é£å…¥åŠ¨ç”»
}

/** é˜²é‡å¤ï¼šç§»é™¤æ—§çš„ä¸´æ—¶ç›‘å¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ */
if ((window as any).__SIM_TMP_OFF__) {
  (window as any).__SIM_TMP_OFF__();
  delete (window as any).__SIM_TMP_OFF__;
}

/** åªæ³¨å†Œä¸€æ¬¡ */
(function initSimOnce() {
  if ((window as any).__SIM_INITED__) return;
  document.addEventListener('click', handleSimClick, { capture: true });
  document.addEventListener('DOMContentLoaded', updateBadge);
  (window as any).__SIM_INITED__ = true;
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    updateBadge();
  }
})();

/* ================== END (STABLE) ================== */

/* ============= QUICK BACKTEST (STABLE FALLBACK) ============= */
function openQuickBacktestStable(symbol: string, strategy: string) {
  const existing = document.getElementById('qb-overlay');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'qb-overlay';
  Object.assign(overlay.style, {
    position: 'fixed', inset: '0', background: 'rgba(0,0,0,0.55)',
    display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: '2147483646'
  } as CSSStyleDeclaration);

  const modal = document.createElement('div');
  Object.assign(modal.style, {
    width: 'min(92vw, 680px)', maxHeight: '80vh', overflowY: 'auto',
    background: '#0F1621', color: '#E6EDF6', border: '1px solid #1F2A3A',
    borderRadius: '16px', boxShadow: '0 6px 16px rgba(0,0,0,0.3)', padding: '16px'
  } as CSSStyleDeclaration);
  modal.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
      <div style="font-weight:700;font-size:18px;">${strategy} Â· ${symbol} Â· å¿«é€Ÿå›æµ‹</div>
      <button id="qb-close" style="border:1px solid #1F2A3A;border-radius:10px;background:#121C2A;color:#A7B1C2;padding:6px 10px;cursor:pointer;">å…³é—­</button>
    </div>
    <div id="qb-content" style="padding:12px;color:#A7B1C2;">åŠ è½½å›æµ‹â€¦</div>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  (modal.querySelector('#qb-close') as HTMLElement)?.addEventListener('click', () => overlay.remove());
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });

  const content = modal.querySelector('#qb-content') as HTMLElement;

  (async () => {
    try {
      const resp = await fetch(`${BASE_API}/api/backtest/${encodeURIComponent(symbol)}?days=30&strategy=${encodeURIComponent(strategy)}`);
      if (!resp.ok) throw new Error('net');
      const payload = await resp.json();
      if (!payload || payload.success === false) throw new Error('api');
      const data = payload.data || {};
      const win = data.winRate ?? '--';
      const trades = data.trades ?? '--';
      const maxdd = data.maxDrawdown ?? '--';
      content.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px;">
          <div>èƒœç‡ï¼š<strong>${win}%</strong></div>
          <div>äº¤æ˜“æ¬¡æ•°ï¼š<strong>${trades}</strong></div>
          <div>æœ€å¤§å›æ’¤ï¼š<strong>${maxdd}%</strong></div>
        </div>
        <div style="font-size:14px;color:#94a3b8;">æç¤ºï¼šæœåŠ¡ç«¯è¿”å›æœ‰é™å­—æ®µæ—¶å±•ç¤ºç²¾ç®€æ¦‚è§ˆã€‚</div>
      `;
    } catch (_) {
      // ç¦»çº¿/å¤±è´¥ï¼šå±•ç¤ºæœ¬åœ°æ¨¡æ‹Ÿå ä½ï¼Œé¿å…ç©º
      const mock = Array.from({length:6}, () => ({
        date: new Date(Date.now() - Math.floor(Math.random()*30)*86400000).toISOString().slice(0,10),
        side: Math.random()>0.5?'BUY':'SELL',
        pnl: (Math.random()*6-2).toFixed(2),
        hold: `${Math.floor(Math.random()*72)+6}h`
      }));
      content.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px;">
          <div>èƒœç‡ï¼š<strong>--</strong></div>
          <div>äº¤æ˜“æ¬¡æ•°ï¼š<strong>${mock.length}</strong></div>
          <div>æœ€å¤§å›æ’¤ï¼š<strong>--</strong></div>
        </div>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #1F2A3A;">æ—¥æœŸ</th><th style="text-align:left;padding:6px;border-bottom:1px solid #1F2A3A;">æ–¹å‘</th><th style="text-align:left;padding:6px;border-bottom:1px solid #1F2A3A;">ç›ˆäº%</th><th style="text-align:left;padding:6px;border-bottom:1px solid #1F2A3A;">æŒä»“</th></tr></thead>
          <tbody>
            ${mock.map(r=>`<tr><td style="padding:6px;border-bottom:1px solid #1F2A3A;">${r.date}</td><td style="padding:6px;border-bottom:1px solid #1F2A3A;">${r.side}</td><td style="padding:6px;border-bottom:1px solid #1F2A3A;">${r.pnl}%</td><td style="padding:6px;border-bottom:1px solid #1F2A3A;">${r.hold}</td></tr>`).join('')}
          </tbody>
        </table>
      `;
    }
  })();
}

// æ¡¥æ¥ï¼šè‹¥æœªå®šä¹‰å…¨å±€ openQuickBacktestï¼Œåˆ™æä¾›ç¨³å®šç‰ˆ
if (!(window as any).openQuickBacktest) {
  (window as any).openQuickBacktest = (symbol: string, strategy: string) => openQuickBacktestStable(symbol, strategy);
}
